---
title: восстановление сайта;
titleSuffix: Configuration Manager
description: Сведения о восстановлении сайтов в Configuration Manager.
ms.date: 08/23/2019
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: conceptual
ms.assetid: 19539f4d-1667-4b4c-99a1-9995f12cf5f7
author: mestew
ms.author: mstewart
manager: dougeby
ms.openlocfilehash: 14f319cfa1d09cf21cc5da5ed4a9fde9b9b9799b
ms.sourcegitcommit: bbf820c35414bf2cba356f30fe047c1a34c5384d
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81708532"
---
# <a name="recover-a-configuration-manager-site"></a>Восстановление сайта Configuration Manager

*Область применения: Configuration Manager (Current Branch)*

Запустите процесс восстановления сайта Configuration Manager после его сбоя или потери данных в базе данных сайта. Исправление и повторная синхронизация данных — основные задачи восстановления сайта, выполнить которые необходимо, чтобы избежать перебоев в работе.

В разделах этой статьи описано, как восстанавливать сайты Configuration Manager. Сведения о создании резервных копий см. в статье [Резервное копирование сайтов Configuration Manager](backup-and-recovery.md).

## <a name="considerations-before-recovering-a-site"></a>Предварительные требования

> [!Important]  
> Эти сведения распространяются только на сценарии восстановления сайта. Если вы обновляете локальную инфраструктуру, а не активно восстанавливаете неработающий сайт, ознакомьтесь со следующими статьями:
>
> - [Обновление локальной инфраструктуры](upgrade-on-premises-infrastructure.md)
> - [Изменение инфраструктуры](modify-your-infrastructure.md)

### <a name="prepare-the-server-hardware"></a>Подготовка оборудования для сервера

<!-- 2841893 -->

Убедитесь, что на сервере сайта отсутствуют существующие конфигурации. Любые предыдущие конфигурации могут вызвать конфликты в процессе восстановления сайта. Воспользуйтесь одним из приведенных ниже вариантов для серверного оборудования.

- Используйте новый сервер, который соответствует общим требованиям и требованиям к восстановлению.

- Отформатируйте диски и переустановите ОС на существующем сервере. Убедитесь, что она соответствует общим требованиям и требованиям к восстановлению.

- Повторно используйте существующий сервер, который вы очистили.

Для очистки существующего сервера выполните одну из следующих процедур.

#### <a name="clean-an-existing-server-for-site-server-recovery-only"></a>Очищение существующего сервера только для восстановления сервера сайта

1. Удалите разделы реестра SMS: `HKLM\Software\Microsoft\SMS`.
2. Удалите из папки `HKLM\System\CurrentControlSet\Services` любые записи реестра, которые начинаются с `SMS`. Пример.
    - SMS_DISCOVERY_DATA_MANAGER;
    - SMS_EXECUTIVE
    - SMS_INBOX_MONITOR;
    - SMS_INVENTORY_DATA_LOADER;
    - SMS_LAN_SENDER;
    - SMS_MP_FILE_DISPATCH_MANAGER;
    - SMS_SCHEDULER;
    - SMS_SITE_BACKUP;
    - SMS_SITE_COMPONENT_MANAGER
    - SMS_SITE_SQL_BACKUP;
    - SMS_SITE_VSS_WRITER;
    - SMS_SOFTWARE_METERING_PROCESSOR;
    - SMS_STATE_SYSTEM;
    - SMS_STATUS_MANAGER;
    - SMS_WSUS_SYNC_MANAGER;
    - SMSvcHost 3.0.0.0;
    - SMSvcHost 4.0.0.0.
3. Удалите консоль Configuration Manager.
4. Перезагрузите сервер.
5. Убедитесь, что все перечисленные выше разделы реестра удалены.

Теперь сервер готов к процедуре восстановления Configuration Manager.

#### <a name="clean-an-existing-server-for-site-database-recovery-only"></a>Очищение существующего сервера только для восстановления базы данных сайта

1. Создайте резервную копию базы данных сайта. Создайте также резервные копии других вспомогательных баз данных, например WSUS.
2. Обязательно запишите имя сервера SQL Server и имя экземпляра.
3. Удалите базу данных сайта с сервера SQL Server вручную.
4. Перезапустите SQL Server.

Теперь сервер готов к процедуре восстановления Configuration Manager.

#### <a name="clean-an-existing-server-for-full-recovery"></a>Очищение существующего сервера для полного восстановления

1. Создайте резервную копию базы данных сайта. Создайте также резервные копии других вспомогательных баз данных, например WSUS.
2. Создайте копию библиотеки содержимого.
3. Удалите базу данных сайта с сервера SQL Server вручную.
4. Удалите сайт Configuration Manager.
5. Удалите папку установки Configuration Manager и все другие папки Configuration Manager вручную.
6. Перезагрузите сервер.
7. Восстановите библиотеку содержимого и другие базы данных, такие как WSUS.

Теперь сервер готов к процедуре восстановления Configuration Manager.

### <a name="use-a-supported-version-and-same-edition-of-sql-server"></a>Использование поддерживаемой версии и того же выпуска SQL Server

<!-- SCCMDocs#751 -->

Если возможно, используйте ту же версию SQL Server. Тем не менее поддерживается восстановление базы данных до более новой версии.

Не меняйте выпуск SQL Server. Восстановление базы данных сайта из выпуска Standard в выпуск Enterprise не поддерживается.

Дополнительные требования к конфигурации SQL Server:

- SQL Server не должен быть настроен на работу в **однопользовательском режиме**.
- Убедитесь, что файлы MDF и LDF являются допустимыми. При восстановлении сайта проверка состояния файлов не выполняется.  

### <a name="sql-server-always-on-availability-groups"></a>Группы доступности SQL Server AlwaysOn

Если вы используете группу доступности SQL Server AlwaysOn для размещения базы данных сайта, измените планы восстановления (см. руководство по [подготовке к использованию SQL Server AlwaysOn](../deploy/configure/sql-server-alwayson-for-a-highly-available-site-database.md#changes-for-site-recovery)).

### <a name="database-replicas"></a>Реплики базы данных

После восстановления базы данных сайта, настроенной для реплик базы данных, перенастройте каждую реплику. Перед использованием реплик базы данных повторно создайте публикации и подписки.

## <a name="determine-your-recovery-options"></a>Определение параметров восстановления

При восстановлении сервера первичного сайта Configuration Manager и сайта центра администрирования (CAS) следует учитывать два основных компонента: **сервер сайта** и **базу данных сайта**.
В следующих разделах описано, как выбрать оптимальный вариант для вашего сценария восстановления.

> [!NOTE]  
> Когда программа установки Configuration Manager обнаруживает на сервере существующий сайт, для него можно запустить восстановление, но варианты восстановления сервера сайта в этом случае ограничены. Например, если запустить программу установки на существующем сервере сайта, при выборе восстановления можно будет восстановить сервер базы данных сайта, но возможность восстановления сервера сайта будет отключена.

### <a name="site-server-recovery-options"></a>Параметры восстановления сервера сайта

Запустите программу установки Configuration Manager из копии папки **CD.Latest**, созданной за пределами папки установки Configuration Manager.  

- Если запустить программу установки из меню **Пуск** на сервере сайта, вариант **Восстановить сайт** будет недоступен.  

- Если вы установили обновления из консоли Configuration Manager до резервного копирования, вы не сможете переустановить сайт, используя программу установки из следующих расположений:

  - установочный носитель;
  - путь установки Configuration Manager.

Затем выберите вариант **Восстановить сайт**. Предлагаются следующие варианты восстановления отказавшего сервера сайта.  

#### <a name="recover-the-site-server-using-an-existing-backup"></a>Восстановление сервера сайта с помощью существующей резервной копии

Используйте этот вариант при наличии резервной копии сервера сайта Configuration Manager, созданной до сбоя сайта. Сайт создает эту резервную копию как часть задачи обслуживания **Резервное копирование сервера сайта**. Сайт переустанавливается, а его параметры настраиваются исходя из тех, которые установлены для резервной копии.  

#### <a name="reinstall-the-site-server"></a>Переустановка сервера сайта

Используйте этот вариант при отсутствии резервной копии сервера сайта. Сервер сайта переустанавливается, и при этом необходимо задать параметры сайта, как во время первоначальной установки.  

- Укажите те же код сайта и имя базы данных сайта, которые использовались при первоначальной установке отказавшего сайта.  

- Сайт можно переустановить на новом компьютере с новой операционной системой.  

- Сервер должен использовать те же имя узла и полное доменное имя (FQDN), которые применялись для сервера исходного сайта.

### <a name="site-database-recovery-options"></a>Параметры восстановления базы данных сайта

В программе установки Configuration Manager предлагаются следующие варианты восстановления базы данных сайта.  

#### <a name="recover-the-site-database-using-a-backup-set"></a>Восстановление базы данных сайта с помощью резервного набора данных

Используйте этот вариант при наличии резервной копии базы данных сайта Configuration Manager, созданной до сбоя базы данных. Сайт создает эту резервную копию как часть задачи обслуживания **Резервное копирование сервера сайта**. При восстановлении первичного сайта в иерархии процесс восстановления извлекает с CAS любые изменения, внесенные в базу данных сайта после последнего резервного копирования. При восстановлении CAS процесс восстановления извлекает эти изменения с эталонного первичного сайта. Если восстанавливается база данных автономного первичного сайта, то изменения, сделанные на сайте после последнего резервного копирования, теряются.  

Если восстанавливается база данных сайта в иерархии, логика восстановления различна для CAS и первичного сайта. Она также различается для случаев, когда последняя резервная копия сделана в течение срока хранения данных отслеживания изменений SQL Server или после истечения этого срока. Дополнительные сведения см. в разделе [Сценарии восстановления базы данных сайта](#site-database-recovery-scenarios) этой статьи.  

> [!NOTE]  
> Восстановление завершится сбоем, если выбрать восстановление базы данных сайта из резервного набора данных, но база данных сайта уже существует.  

#### <a name="create-a-new-database-for-this-site"></a>Создание базы данных для этого сайта

Используйте этот вариант при отсутствии резервной копии базы данных сайта. В иерархии процесс восстановления создает базу данных сайта. При восстановлении дочернего первичного сайта он восстанавливает данные путем репликации с CAS. При восстановлении CAS он реплицирует данные с эталонного первичного сайта. Этот вариант недоступен при восстановлении автономного первичного сайта или CAS, не имеющего первичных сайтов.  

#### <a name="use-a-site-database-that-has-been-manually-recovered"></a>Использование базы данных сайта, восстановленной вручную

Используйте этот вариант, если база данных сайта Configuration Manager уже восстановлена, но требуется завершить процесс восстановления.  

- Configuration Manager может восстановить базу данных сайта из любого из следующих процессов:  

  - задача обслуживания "Резервное копирование" в Configuration Manager;  
  - резервное копирование базы данных вашего сайта с помощью Data Protection Manager (DPM);  
  - другой процесс резервного копирования.  

    Если база данных сайта была восстановлена без использования штатных методов Configuration Manager, для завершения ее восстановления запустите программу установки и выберите этот вариант.  

    > [!NOTE]  
    > При использовании DPM для резервного копирования базы данных сайта используйте процедуры DPM для восстановления базы данных сайта в указанном расположении перед продолжением процесса восстановления в Configuration Manager. Дополнительные сведения о DPM см. в [библиотеке документации по Data Protection Manager](https://docs.microsoft.com/system-center/dpm).  

- При восстановлении базы данных сайта в иерархии процесс восстановления извлекает с CAS любые изменения, внесенные в базу данных сайта после последнего резервного копирования. При восстановлении CAS процесс восстановления извлекает эти изменения с эталонного первичного сайта. Если восстанавливается база данных автономного первичного сайта, то изменения, сделанные на сайте после последнего резервного копирования, теряются.  

#### <a name="skip-database-recovery"></a>Пропуск восстановления базы данных

Используйте этот вариант, если на сервере базы данных сайта Configuration Manager не было потери данных. Данный вариант действителен только тогда, когда база данных сайта находится на разных компьютерах с восстанавливаемым сервером сайта.  

### <a name="sql-server-change-tracking-retention-period"></a>Срок хранения данных для отслеживания изменений в SQL Server

Configuration Manager включает отслеживание изменений для базы данных сайта в SQL Server. Функция отслеживания изменений позволяет Configuration Manager запрашивать информацию об изменениях, внесенных в таблицы базы данных с некоторого момента времени. Срок хранения определяет, как долго хранится информация об отслеживаемых изменениях. По умолчанию для базы данных сайта срок хранения установлен равным 5 дням. При восстановлении базы данных сайта процесс восстановления протекает по разному в зависимости от того, сделана ли резервная копия на протяжении срока хранения или после его окончания. Например, если произошел сбой сервера SQL Server, а последняя резервная копия сделана 7 дней назад, срок хранения истек.

Дополнительные сведения о внутреннем устройстве отслеживания изменений SQL Server см. в следующих публикациях блогов группы разработчиков SQL Server: [Change Tracking Cleanup - part 1](https://blogs.msdn.microsoft.com/sql_server_team/change-tracking-cleanup-part-1/) (Очистка отслеживания изменений — часть 1) и [Change Tracking Cleanup - part 2](https://blogs.msdn.microsoft.com/sql_server_team/change-tracking-cleanup-part-2) (Очистка отслеживания изменений — часть 2).

### <a name="reinitialization-of-site-or-global-data"></a>Повторная инициализация данных сайта или глобальных данных

В процессе повторной инициализации данных сайта или глобальных данных существующие данные в базе данных сайта заменяются данными из другой базы данных сайта. Например, если сайт "Отчеты" повторно инициализирует данные с сайта "Списки", выполняются следующие действия.

- Данные копируются с сайта "Списки" на сайт "Отчеты".
- Существующие данные сайта "Списки" удаляются из базы данных сайта на сайте "Отчеты".
- Данные, скопированные с сайта "Списки", вставляются в базу данных сайта для сайта "Отчеты".

#### <a name="example-scenario-1-the-primary-site-reinitializes-the-global-data-from-the-cas"></a>Пример сценария 1. Первичный сайт повторно инициализирует глобальные данные с CAS.

В процессе восстановления имеющиеся глобальные данные этого первичного сайта удаляются из базы данных первичного сайта и заменяются глобальными данными, скопированными с CAS.

#### <a name="example-scenario-2-the-cas-reinitializes-the-site-data-from-a-primary-site"></a>Пример сценария 2. CAS повторно инициализирует данные сайта с первичного сайта.

В процессе восстановления существующие данные этого первичного сайта удаляются из базы данных CAS. Они заменяются данными сайта, скопированными с первичного сайта. Данные сайта других первичных сайтов остаются без изменений.

### <a name="site-database-recovery-scenarios"></a>Сценарии восстановления базы данных сайта

После восстановления базы данных сайта из резервной копии Configuration Manager предпринимает попытку восстановления изменений данных сайта и глобальных данных, внесенных с момента последнего резервного копирования базы данных. Ниже представлены действия, выполняемые Configuration Manager после восстановления базы данных сайта из резервной копии.  

#### <a name="recovered-site-is-a-cas"></a>Восстановленный сайт представляет собой CAS

- Резервная копия базы данных в пределах срока хранения отслеживания изменений  

  - **Глобальные данные**. Изменения глобальных данных после резервного копирования реплицируются со всех первичных сайтов.  

  - **Данные сайта**. Изменения данных сайта после резервного копирования реплицируются со всех первичных сайтов.  

- Резервная копия базы данных старше, чем срок хранения отслеживания изменений  

  - **Глобальные данные**. CAS повторно инициализирует глобальные данные с эталонного первичного сайта (если он указан). Затем все остальные первичные сайты повторно инициализируют глобальные данные с CAS. Если эталонный сайт не указан, все первичные сайты повторно инициализируют глобальные данные с CAS. Эти данные были восстановлены из резервной копии.  

  - **Данные сайта**. CAS повторно инициализирует данные сайта с каждого первичного сайта.  

#### <a name="recovered-site-is-a-primary-site"></a>Восстановленный сайт представляет собой первичный сайт

- Резервная копия базы данных в пределах срока хранения отслеживания изменений  

  - **Глобальные данные**. Изменения глобальных данных после резервного копирования реплицируются с CAS.  

  - **Данные сайта**. CAS повторно инициализирует данные с первичного сайта. После резервного копирования изменения теряются. Клиенты повторно создают большую часть данных при отправке сведений на первичный сайт.  

- Резервная копия базы данных старше, чем срок хранения отслеживания изменений  

  - **Глобальные данные**. Первичный сайт повторно инициализирует глобальные данные с CAS.  

  - **Данные сайта**. CAS повторно инициализирует данные с первичного сайта. После резервного копирования изменения теряются. Клиенты повторно создают большую часть данных при отправке сведений на первичный сайт.  

## <a name="site-recovery-procedures"></a>Процедуры по восстановлению сайта

Для восстановления сервера сайта и базы данных сайта используется одна из следующих процедур.

### <a name="start-a-site-recovery-in-the-setup-wizard"></a>Начало восстановления сайта в мастере установки

1. Скопируйте [папку CD.Latest](the-cd.latest-folder.md) в расположение за пределами папки установки Configuration Manager. В копии папки CD.Latest запустите мастер установки Configuration Manager.  

2. На странице **Приступая к работе** выберите **Recover a site** (Восстановить сайт), а затем нажмите кнопку **Далее**.  

3. Завершите работу мастера, выбрав параметры, необходимые для восстановления сайта.  

     - Во время восстановления программа установки определит порт SQL Server Service Broker (SSB), используемый сервером SQL Server. Не изменяйте этот порт во время выполнения восстановления, иначе после его завершения репликация данных будет нарушена.  

     - Вы можете указать в мастере установки любой путь (исходный или новый) для установки Configuration Manager.  

### <a name="start-an-unattended-site-recovery"></a>Запуск автоматического восстановления сайта

1. Подготовьте сценарий автоматической установки с параметрами, необходимыми для восстановления сайта. Дополнительные сведения см. в статье [Автоматическое восстановление сайта](unattended-recovery.md).  

2. Запустите программу установки Configuration Manager с помощью параметра команды `/script`. Например, вы создаете файл инициализации программы установки **ConfigMgrUnattend.ini**. Вы сохраняете его в каталог `C:\Temp` компьютера, на котором запускаете программу установки. Используйте следующую команду:  

    `setup.exe /script C:\temp\ConfigMgrUnattend.ini`  

> [!NOTE]  
> После восстановления CAS может произойти сбой репликации определенных данных сайта с дочерних сайтов. Это могут быть данные об инвентаризации оборудования или программного обеспечения, а также сообщения о состоянии.
>
> При возникновении этой проблемы повторно инициализируйте **ConfigMgrDRSSiteQueue** для репликации базы данных. Используйте **SQL Server Manager** для выполнения следующего запроса к базе данных сайта для CAS:
>
> ``` SQL
> IF EXISTS (SELECT * FROM sys.service_queues WHERE name = 'ConfigMgrDRSSiteQueue' AND is_receive_enabled = 0)  
>  
> ALTER QUEUE [dbo].[ConfigMgrDRSSiteQueue] WITH STATUS = ON
> ```

## <a name="post-recovery-tasks"></a>Задачи, выполняемые после восстановления

После восстановления сайта необходимо выполнить несколько задач, чтобы завершить процесс. Следующие разделы содержат сведения о завершении процесса восстановления.

### <a name="reenter-user-account-passwords"></a>Повторный ввод паролей учетных записей пользователей

После восстановления сервера сайта повторно введите пароли для всех учетных записей пользователей на сайте. Эти пароли сбрасываются во время восстановления сайта. Учетные записи отображаются на странице **Завершено** мастера установки после завершения восстановления сайта. Список также сохраняется в `C:\ConfigMgrPostRecoveryActions.html` на сервере восстановленного сайта.

#### <a name="reenter-user-account-passwords-after-site-recovery"></a>Повторный ввод паролей учетных записей пользователей после восстановления сайта

1. Откройте консоль Configuration Manager и подключитесь к восстановленному сайту.  

2. В рабочей области **Администрирование** разверните узел **Безопасность** и выберите **Учетные записи**.  

3. Повторно введите пароль для каждой учетной записи, выполнив следующие действия.  

     1. Выберите учетную запись в списке учетных записей, определенных после восстановления сайта.  

     2. На ленте щелкните **Свойства**.  

     3. На вкладке **Общие** выберите **Задать**, после чего повторно введите пароль для учетной записи.  

     4. Щелкните **Проверить**, укажите соответствующий источник данных для выбранной учетной записи пользователя, а затем выберите **Проверить подключение**. На этом шаге выполняется тестирование возможности подключения учетной записи пользователя к источнику данных и проверяются учетные записи.  

     5. Нажмите кнопку **ОК**, чтобы сохранить измененный пароль, а затем щелкните **ОК**, чтобы закрыть страницу свойств учетной записи.  

#### <a name="reenter-pxe-passwords"></a>Повторное введение паролей PXE

<!-- SCCMDocs#1683 -->

1. В консоли Configuration Manager перейдите в рабочую область **Администрирование** и выберите узел **Точки распространения**. Любая локальная точка распространения со значением **Да** в столбце **PXE** включена для PXE и может иметь пароль для повторного ввода.

1. Выберите точку распространения с поддержкой PXE и щелкните **Свойства** на ленте.

1. Перейдите на вкладку **PXE**.

1. Если параметр **Требовать пароль при использовании компьютерами протокола PXE** включен, введите и подтвердите пароль.

1. Нажмите кнопку **ОК**, чтобы сохранить изменения и закрыть свойства.

Повторите этот процесс для любой другой локальной точки распространения с поддержкой PXE.

#### <a name="reenter-task-sequence-passwords"></a>Повторное введение паролей последовательности задач

<!-- SCCMDocs#1683 -->

1. В консоли Configuration Manager перейдите к рабочей области **Библиотека программного обеспечения**, разверните узел **Операционные системы** и выберите **Последовательности задач**.

1. Выберите последовательность задач, а затем на ленте щелкните **Изменить**.

1. Просмотрите приведенные ниже шаги для повторного введения паролей.

    - **Применить настройки Windows**. Если вы включите этот параметр и укажете пароль локального администратора, вам нужно повторно ввести и подтвердить пароль.

    - **Применить параметры сети**. Выберите **Задать** для учетной записи, которая имеет разрешение на присоединение к домену. Введите и подтвердите пароль, а затем выберите **Проверить**.

    - **Записать образ операционной системы**. Выберите **Задать** для учетной записи, используемой для доступа к целевому расположению. Введите и подтвердите пароль, а затем выберите **Проверить**.

    - **Подключить к сетевой папке**. Выберите **Задать** для учетной записи, используемой для подключения к сетевой папке. Введите и подтвердите пароль, а затем выберите **Проверить**.

    - **Включить BitLocker**. Повторно введите ПИН-код, если вы используете параметр управления разделами **Доверенный платформенный модуль и ПИН-код**.

    - **Присоединить к домену или рабочей группе**. Выберите **Задать** для учетной записи, которая имеет разрешение на присоединение к домену. Введите и подтвердите пароль, а затем выберите **Проверить**.

    - **Выполнить из командной строки**. Выберите **Задать**, если вы используете параметр **Запустите этот этап в виде следующей учетной записи**. Введите и подтвердите пароль, а затем выберите **Проверить**.

    - **Запустить сценарий PowerShell**. Выберите **Задать**, если вы используете параметр **Запустите этот этап в виде следующей учетной записи**. Введите и подтвердите пароль, а затем выберите **Проверить**.

Повторите этот процесс для всех последовательностей задач.

### <a name="reenter-sideloading-keys"></a>Повторный ввод ключей для загрузки неопубликованных приложений

После восстановления сервера сайта повторно введите ключи для загрузки неопубликованных приложений Windows, указанные для сайта. Эти ключи сбрасываются при восстановлении сайта. После повторного ввода ключей для загрузки неопубликованных приложений сайт сбрасывает счетчик ключей Windows для загрузки неопубликованных приложений в столбце **Количество использованных активаций**.

Например, перед сбоем сайта счетчик **Всего активаций** счетчик показывает **100**. Число ключей, которые использовались устройствами, или **Количество использованных активаций** равно **90**. После восстановления сайта счетчик **Всего активаций** будет по-прежнему отображать значение **100**, а в столбце **Количество использованных активаций** будет отображаться неправильное значение **0**. После того как 10 новых устройств используют ключ для загрузки неопубликованных приложений, ключей для загрузки неопубликованных приложений больше не останется, и следующему 11-му устройству не удастся применить ключ для загрузки неопубликованных приложений.

### <a name="recreate-azure-services"></a>Повторное создание служб Azure

<!-- SCCMDocs#1022 -->

В Configuration Manager версии 1806 после восстановления сайта вы увидите следующую ошибку в файле cloudmgr.log:

`Index (zero-based) must be greater than or equal to zero`

Чтобы устранить эту проблему, [обновите секретный ключ](../deploy/configure/azure-services-wizard.md#bkmk_renew) для каждого подключения к клиенту Azure.

### <a name="configure-ssl-for-site-system-roles-that-use-iis"></a>Настройка SSL для ролей систем сайта, использующих IIS

При восстановлении систем сайта, использующих службы IIS и настроенных на работу по протоколу HTTPS, заново настройте службы IIS для использования сертификата веб-сервера.

### <a name="reinstall-hotfixes"></a>Повторная установка исправлений

После восстановления сайта необходимо переустановить все [исправления, полученные по внештатным каналам](updates.md#bkmk_outofband), которые использовались на сервере сайта. После восстановления сайта просмотрите список ранее установленных исправлений на странице **Завершено** мастера установки. Список также сохраняется в `C:\ConfigMgrPostRecoveryActions.html` на сервере восстановленного сайта.

### <a name="recover-custom-reports"></a>Восстановление пользовательских отчетов

Некоторые клиенты создают пользовательские отчеты в службах SQL Server Reporting Services В случае сбоя этого компонента восстановите отчеты из резервной копии сервера отчетов. Дополнительные сведения о восстановлении пользовательских отчетов в службах Reporting Services см. в статье [Операции резервного копирования и восстановления для установки Reporting Services](https://docs.microsoft.com/sql/reporting-services/install-windows/backup-and-restore-operations-for-reporting-services).

### <a name="recover-content-files"></a>Восстановление файлов содержимого

База данных сайта отслеживает расположения, в которые сервер сайта сохраняет файлы содержимого. Сами файлы содержимого не архивируются и не восстанавливаются в ходе процесса резервного копирования и восстановления. Чтобы полностью восстановить файлы содержимого, восстановите библиотеку содержимого и исходные файлы пакета в первоначальном расположении. Существует несколько способов восстановления файлов содержимого. Самым простым является восстановление файлов из резервной копии файловой системы сервера сайта.

Если у вас нет резервной копии файловой системы для исходных файлов пакета, скопируйте или загрузите их вручную. Этот процесс аналогичен первоначальному созданию пакета. Найти местоположение источника пакета для всех пакетов и приложений можно с помощью следующего запроса в SQL Server: `SELECT * FROM v_Package`. Определите сайт источника пакета по первым трем символам идентификатора пакета. Например, если пакет имеет идентификатор CEN00001, то код сайта источника — CEN. Исходные файлы пакетов должны восстанавливаться в том же месте, где они находились до сбоя.

Если отсутствует резервная копия файловой системы, содержащая библиотеку содержимого, возможны следующие варианты восстановления.  

- **Импорт файла предварительно подготовленного содержимого**. В иерархии Configuration Manager можно создать файл предварительно подготовленного содержимого со всеми пакетами и приложениями из другого расположения. Затем этот файл можно импортировать для восстановления библиотеки содержимого на сервере сайта.  

- **Обновление содержимого**. Configuration Manager копирует содержимое из источника пакета в библиотеку содержимого. Для успешного выполнения этого действия исходные файлы пакета должны быть доступны в исходном расположении. Выполните это действие для каждого пакета и приложения.

### <a name="recover-custom-software-updates"></a>Восстановление пользовательских обновлений программного обеспечения

Если в план резервного копирования были включены файлы базы данных Updates Publisher, можно восстановить базы данных в случае сбоя компьютера с Updates Publisher. Дополнительные сведения об Updates Publisher см. в статье [System Center Updates Publisher](../../../sum/tools/updates-publisher.md).

#### <a name="restore-the-updates-publisher-database"></a>Восстановление базы данных Updates Publisher

1. Переустановите Updates Publisher на восстанавливаемом компьютере.  

2. Скопируйте файл базы данных **Scupdb.sdf** из папки резервной копии в папку `%USERPROFILE%\AppData\Local\Microsoft\System Center Updates Publisher 2011\5.00.1727.0000\` на компьютере, где выполняется Updates Publisher.  

3. Если несколько пользователей используют Updates Publisher на компьютере, скопируйте каждый файл базы данных в соответствующую папку профиля пользователя.  

### <a name="user-state-migration-data"></a>Данные миграции состояния пользователя

В свойствах точки миграции состояния указываются папки, в которых хранятся данные состояния пользователей. После восстановления точки миграции состояния вручную восстановите данные состояния пользователя на сервере. Восстановите их в тех же папках, в которых данные хранились до сбоя.

### <a name="regenerate-the-certificates-for-distribution-points"></a>Повторное создание сертификатов для точек распространения

После восстановления сайта файл **distmgr.log** может содержать следующую запись для одной точки распространения или нескольких: `Failed to decrypt cert PFX data`. Эта запись означает, что сайту не удалось расшифровать данные сертификата точки распространения. Чтобы устранить эту проблему, повторно создайте или импортируйте сертификат для затронутых точек распространения. Используйте командлет PowerShell [Set-CMDistributionPoint](https://docs.microsoft.com/powershell/module/configurationmanager/set-cmdistributionpoint).

### <a name="update-certificates-used-for-cloud-based-distribution-points"></a>Обновление сертификатов, используемых для облачных точек распространения

Configuration Manager требуется сертификат управления Azure, который будет использоваться для обмена данными между сервером сайта и облачными точками распространения. После восстановления сайта обновите сертификаты для облачных точек распространения.

## <a name="recover-a-secondary-site"></a>Восстановление вторичного сайта

Configuration Manager не поддерживает резервное копирование базы данных на вторичном сайте, но поддерживает восстановление путем повторной установки вторичного сайта. Восстановление вторичного сайта требуется в случае сбоя вторичного сайта Configuration Manager.

### <a name="requirements"></a>Requirements (Требования)

- Сервер с настроенными необходимыми правами безопасности должен отвечать всем требованиям, применимым к вторичному сайту.  

- Используйте такой же путь установки, какой использовался на отказавшем сайте.  

- Используйте сервер с той же конфигурацией, что и на отказавшем сервере. В эту конфигурацию входит его полное доменное имя (FQDN).  

- Конфигурация SQL Server для этого сервера должна быть такой же, как на отказавшем сайте.  

  - При восстановлении вторичного сайта Configuration Manager не устанавливает SQL Server Express, если этот компонент отсутствует на компьютере.  

  - Используйте такую же версию и такой же экземпляр SQL Server, какие использовались для базы данных вторичного сайта перед сбоем.  

### <a name="procedure"></a>Процедура

Используйте действие **Восстановить вторичный сайт** в узле **Сайты** в консоли Configuration Manager. В отличие от других типов сайтов при восстановлении вторичного сайта не применяется файл резервной копии. В ходе этого процесса переустанавливаются файлы вторичного сайта на отказавшем сервере. После повторной установки сайта данные вторичного сайта повторно инициализируются с использованием данных с родительского первичного сайта.

В процессе восстановления Configuration Manager проверяет наличие библиотеки содержимого на компьютере вторичного сайта. Он также проверяет доступность необходимого содержимого. Вторичный сайт использует существующую библиотеку содержимого, если она содержит соответствующее содержимое. В противном случае для восстановления библиотеки содержимого вторичного сайта заново распространите или предварительно подготовьте содержимое на сервере.

При наличии точки распространения, не находящейся на сервере вторичного сайта, нет необходимости переустанавливать эту точку распространения при восстановлении вторичного сайта. После восстановления вторичного сайта происходит автоматическая синхронизация с точкой распространения.

Проверить состояние восстановления вторичного сайта можно с помощью действия **Показать состояние установки** узла **Сайты** в консоли Configuration Manager.
