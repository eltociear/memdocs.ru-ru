---
title: Настройка шлюза управления облачными клиентами
titleSuffix: Configuration Manager
description: Используйте это пошаговое руководство для настройки шлюза управления облачными клиентами.
author: aczechowski
ms.author: aaroncz
manager: dougeby
ms.date: 07/26/2019
ms.topic: conceptual
ms.prod: configuration-manager
ms.technology: configmgr-client
ms.assetid: e0ec7d66-1502-4b31-85bb-94996b1bc66f
ms.openlocfilehash: 36d256e674a0fe973eca4bc692a244af034d5cc1
ms.sourcegitcommit: 1442a4717ca362d38101785851cd45b2687b64e5
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2020
ms.locfileid: "82076770"
---
# <a name="set-up-cloud-management-gateway-for-configuration-manager"></a>Настройка шлюза управления облаком для Configuration Manager.

*Область применения: Configuration Manager (Current Branch)*

Эта процедура включает шаги, необходимые для настройки шлюза управления облачными клиентами.

> [!Note]  
> По умолчанию в Configuration Manager эта дополнительная функция отключена. Перед использованием ее необходимо включить. Дополнительные сведения см. в разделе [Включение дополнительных функций из обновлений](../../../servers/manage/install-in-console-updates.md#bkmk_options).


## <a name="before-you-begin"></a>Подготовка к работе

Прежде всего, ознакомьтесь со статьей [Планирование работы шлюза управления облачными клиентами](plan-cloud-management-gateway.md). Сведения в этой статье помогут вам определить проект шлюза управления облачными клиентами.

Используйте следующий контрольный список, чтобы убедиться в наличии всех необходимых сведений и компонентов для создания шлюза.  

- Среда Azure для использования. Например, общедоступное облако Azure или облако Azure для государственных организаций США.  

- Один или несколько сертификатов, необходимых для шлюза управления облачными клиентами, в зависимости от проекта. Дополнительные сведения см. в разделе [Сертификаты для шлюза управления облачными клиентами](certificates-for-cloud-management-gateway.md).  

- Для развертывания шлюза управления облачными клиентами в модели [Azure Resource Manager](plan-cloud-management-gateway.md#azure-resource-manager) необходимо выполнить следующие требования.  

    - Интеграция сайта с [Azure AD](../../../servers/deploy/configure/azure-services-wizard.md) для службы **Управление облачными клиентами**. Обнаружение пользователей Azure AD не требуется.  

    - Поставщики ресурсов **Microsoft.ClassicCompute** и **Microsoft.Storage** должны быть зарегистрированы в подписке Azure. Дополнительные сведения см. в статье об [Azure Resource Manager](https://docs.microsoft.com/azure/azure-resource-manager/resource-manager-supported-services).

    - Администратор подписки должен войти в систему.  

- Глобальное уникальное имя для службы. Это имя содержится в [сертификате проверки подлинности сервера шлюза управления облачными клиентами](certificates-for-cloud-management-gateway.md#bkmk_serverauth).  

- Если CMG поддерживается в качестве облачной точки распространения, глобальное уникальное имя службы CMG, которое вы выбрали, также должно быть доступно, как глобальное уникальное имя учетной записи хранения. Это имя содержится в [сертификате проверки подлинности сервера шлюза управления облачными клиентами](certificates-for-cloud-management-gateway.md#bkmk_serverauth).

- Регион Azure для этого развертывания шлюза управления облачными клиентами.  

- Количество экземпляров виртуальных машин, необходимое для обеспечения масштабируемости и избыточности.  

- Если вам все еще нужно использовать классическое развертывание службы Azure в Configuration Manager версии 1810 или более ранней, вам необходимо выполнить следующие требования:  

    > [!Important]  
    > Начиная с версии 1810 классическое развертывание службы в Azure не рекомендуется использовать в Configuration Manager. Используйте развертывания с помощью Azure Resource Manager для шлюза управления облачными клиентами. Дополнительные сведения см. в разделе [Планирование CMG](plan-cloud-management-gateway.md#azure-resource-manager).  
    >
    > Начиная с версии Configuration Manager 1902, Azure Resource Manager — единственный механизм развертывания для новых экземпляров шлюза управления облачными клиентами.<!-- 3605704 -->

    - Идентификатор подписки Azure.  

    - Сертификат управления Azure.  


## <a name="set-up-a-cmg"></a>Настройка шлюза управления облачными клиентами

Выполните эту процедуру на сайте верхнего уровня. Это сайт должен быть сайтом центра администрирования или автономным первичным сайтом.

1. В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Облачные службы** и выберите **Шлюз управления облачными клиентами**.  

2. Выберите на ленте команду **Создать шлюз управления облачными клиентами**.  

3. На странице мастера "Общие" выберите **Войти**. Выполните проверку подлинности с помощью учетной записи администратора подписки Azure. Мастер автоматически заполняет оставшиеся поля данными, сохраненными в качестве предварительных требований интеграции Azure AD. Если вы владеете несколькими подписками, выберите нужный **код подписки**.

    > [!Note]  
    > Начиная с версии 1810 классическое развертывание службы в Azure не рекомендуется использовать в Configuration Manager. В версии 1902 и более ранних выберите **Azure Resource Manager deployment** (Развертывание Azure Resource Manager) в качестве метода развертывания CMG.
    >
    > Если вам нужно использовать классическое развертывание службы, выберите соответствующий параметр на этой странице. Сначала введите **идентификатор подписки Azure**. Затем нажмите кнопку **Обзор** и выберите PFX-файл для сертификата управления Azure.

4. Укажите **среду Azure** для этого шлюза. Набор параметров в раскрывающемся списке зависит от выбранного метода развертывания.  

5. Выберите **Далее**. Дождитесь завершения проверки сайтом подключения к Azure.  

6. На странице параметров мастера сначала нажмите кнопку **Обзор** и выберите PFX-файл для сертификата проверки подлинности сервера шлюза управления облачными клиентами. Имя из этого сертификата передается в обязательные поля **полное доменное имя службы** и **имя службы**.  

   > [!NOTE]  
   > Сертификат проверки подлинности сервера шлюза CMG поддерживает подстановочные знаки. Если используется сертификат с подстановочным знаком, замените звездочку (`*`) в поле **полное доменное имя службы** нужным именем узла для шлюза.<!--491233-->  

7. Щелкните раскрывающийся список **Регион**, чтобы выбрать регион Azure для этого шлюза.  

8. Выберите параметр **Группа ресурсов**.
   1. Если вы выбрали вариант **Использовать существующую**, выберите существующую группу ресурсов из раскрывающегося списка. Эта группа ресурсов должна существовать в регионе, который вы выбрали на шаге 7. Если выбрали существующую группу ресурсов, которая находится в регионе, отличном от выбранного ранее, подготовка CMG завершится ошибкой.
   2. Если вы выбрали вариант **Создать новую**, введите имя группы ресурсов.

9. В поле **Экземпляр виртуальной машины** введите число виртуальных машин для этой службы. Значение по умолчанию — 1, но можно вертикально увеличить масштаб до 16 виртуальных машин на один шлюз управления облачными клиентами.  

10. Перейдите на вкладку **Сертификаты**, чтобы добавить доверенные корневые сертификаты клиента. Добавьте все сертификаты в цепочку сертификатов.  

    > [!Note]  
    > Начиная с версии 1806, при создании шлюза управления облачными клиентами больше не нужно указывать доверенный корневой сертификат на странице "Параметры". Этот сертификат не требуется при использовании Azure Active Directory (Azure AD) для проверки подлинности клиента, хотя он требовался в мастере. Если вы используете сертификаты проверки подлинности клиента на основе PKI, то вам по-прежнему необходимо добавить доверенный корневой сертификат в шлюз управления облачными клиентами.<!--SCCMDocs-pr issue #2872-->  
    >
    > В версии 1902 и более ранних версиях можно добавить только два доверенных корневых центра сертификации и четыре промежуточных (подчиненных) центра сертификации.<!-- SCCMDocs-pr#4022 -->

11. По умолчанию мастер включает параметр **Проверять отзыв сертификата клиента**. Чтобы эта проверка прошла успешно, список отзыва сертификатов должен быть опубликован в общем доступе. Дополнительные сведения см. в разделе [Публикация списка отзыва сертификатов](security-and-privacy-for-cloud-management-gateway.md#bkmk_crl).  

12. Начиная с версии 1906 можно использовать параметр **Enforce TLS 1.2** (Принудительно использовать TLS 1.2). Этот параметр применяется только к виртуальной машине облачной службы Azure. Это не относится к локальным серверам или клиентам сайта Configuration Manager. Дополнительные сведения о TLS 1.2 см. в статье [Как включить TLS 1.2](../../../plan-design/security/enable-tls-1-2.md).<!-- SCCMDocs-pr#4021 -->

13. Начиная с версии 1806, в мастере по умолчанию включен параметр **Разрешить шлюзу управления облачными клиентами функционировать как облачной точке распространения и предоставлять содержимое из службы хранилища Azure**. Теперь шлюз управления облачными клиентами может предоставлять содержимое клиентам. Эта возможность сокращает число необходимых сертификатов и затраты на виртуальные машины Azure.  

14. Выберите **Далее**.  

15. Чтобы отслеживать трафик шлюза управления облачными клиентами с пороговым значением 14 дней, установите флажок, чтобы включить оповещение о достижении порогового значения. Затем укажите пороговое значение и процентные значения, по которым будут запускаться оповещения разных уровней. Завершив настройку, нажмите кнопку **Далее**.  

16. Проверьте параметры и нажмите кнопку **Далее**. Configuration Manager начнет настройку службы. После закрытия мастера полная подготовка службы в Azure займет от 5 до 15 минут. Чтобы узнать, когда новый шлюз управления облачными клиентами будет готов к использованию, проверьте столбец **Состояние**.  

    > [!Note]  
    > Для устранения неполадок при развертывании шлюза используйте журналы **CloudMgr.log** и **CMGSetup.log** Дополнительные сведения см. в [файлах журнала](../../../plan-design/hierarchy/log-files.md#cloud-management-gateway).


## <a name="configure-primary-site-for-client-certificate-authentication"></a>Настройка первичного сайта для проверки подлинности сертификата клиента

Если вы используете [сертификаты проверки подлинности клиентов](certificates-for-cloud-management-gateway.md#bkmk_clientauth) для проверки подлинности клиентов в шлюзе, выполните описанную ниже процедуру для настройки каждого первичного сайта.  

1. В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Конфигурация сайта** и выберите **Сайты**.  

2. Выберите первичный сайт, которому назначены интернет-клиенты, и нажмите кнопку **Свойства**.  

3. Перейдите на вкладку **Client Computer Communications** (Взаимодействие с клиентскими компьютерами) страницы свойств первичного сайта и установите флажок **Use PKI client certificate (client authentication) when available** (Использовать сертификат PKI клиента (проверка подлинности клиента) при наличии).  

    > [!Note]
    > Начиная с версии 1906, эта вкладка называется **Communication Security** (Безопасность обмена данными).<!-- SCCMDocs#1645 -->  

4. Если вы не публиковали список отзыва сертификатов, снимите флажок **Клиенты проверяют список отзыва сертификатов для систем сайта**.  


## <a name="add-the-cmg-connection-point"></a>Добавление точки подключения шлюза управления облачными клиентами

Точка подключения шлюза управления облачными клиентами — это роль системы сайта для обмена данными с этим шлюзом. Чтобы добавить точку подключения шлюза, следуйте общим инструкциям по [установке ролей системы сайта](../../../servers/deploy/configure/install-site-system-roles.md). На странице "Выбор системной роли" мастера добавления ролей системы сайта выберите **Точка подключения шлюза управления облачным клиентами**. Затем выберите **имя шлюза управления облачными клиентами**, к которому подключается этот сервер. Мастер показывает регион для выбранного шлюза.

> [!Important]
> Точка подключения шлюза управления облачными клиентами должна иметь [сертификат проверки подлинности клиента](certificates-for-cloud-management-gateway.md#bkmk_clientauth) в некоторых сценариях.

Для устранения неполадок работоспособности службы шлюза используйте журналы **CMGService.log** и **SMS_Cloud_ProxyConnector.log**. Дополнительные сведения см. в [файлах журнала](../../../plan-design/hierarchy/log-files.md#cloud-management-gateway).


## <a name="configure-client-facing-roles-for-cmg-traffic"></a>Настройка ролей на стороне клиента для трафика шлюза управления облачными клиентами

Настройте точку управления, точку распространения и точку обновления ПО для приема трафика шлюза управления облачными клиентами. Выполните эту процедуру на первичном сайте для всех точек управления и точек обновления программного обеспечения, обслуживающих интернет-клиенты.  

1. В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Конфигурация сайта** и выберите узел **Серверы и роли системы сайта**. На вкладке "Главная" ленты в группе "Вид" выберите **Серверы с ролью**. Затем выберите в списке пункт **Точка управления**.  

2. Выберите сервер системы сайта, который вы хотите настроить для трафика шлюза. Выберите роль **Точка управления** в области сведений, а затем на ленте нажмите кнопку **Свойства**.  

3. На странице свойств точки управления в группе "Подключения клиента" установите флажок **Разрешить трафик шлюза управления облачными клиентами Configuration Manager**.

    В зависимости от проекта шлюза и версии Configuration Manager может потребоваться установить флажок **HTTPS**. Дополнительные сведения см. в статье [Включение точки управления для HTTPS](certificates-for-cloud-management-gateway.md#bkmk_mphttps).  

4. Нажмите кнопку **ОК**, чтобы закрыть окно свойств точки управления.  

При необходимости повторите эти шаги для дополнительных точек управления, а также точек обновления программного обеспечения.


## <a name="configure-boundary-groups"></a>Настройка групп границ

<!--3640932-->
Начиная с версии 1902, CMG можно связать с группой границ. Эта конфигурация позволяет установить для клиента параметры по умолчанию или вернуть настройки шлюза управления облачными клиентами в зависимости от связей границ группы.

Дополнительные сведения см. в разделе о [настройке групп границ](../../../servers/deploy/configure/boundary-groups.md).

Когда вы [создаете или настраиваете группу границ](../../../servers/deploy/configure/boundary-group-procedures.md), на вкладке **Ссылки** добавьте шлюз управления облачными клиентами. Это действие позволяет связать шлюз управления облачными клиентами с указанной группой границ.


## <a name="configure-clients-for-cmg"></a>Настройка клиентов для шлюза управления облачными клиентами

После запуска шлюза и ролей системы сайта клиенты получают адрес службы шлюза автоматически при следующем запросе расположения. Для получения расположения службы шлюза клиенты должны находиться в интрасети, если [установка и назначение клиентов Windows 10 не выполнялась с помощью Azure AD для проверки подлинности](../../deploy/deploy-clients-cmg-azure.md). Цикл опроса для запросов расположения составляет каждые 24 часа. Если вы не хотите ждать выполнения запроса в запланированное время, его можно выполнить принудительно, перезапустив службу узла агента SMS (ccmexec.exe) на компьютере.  

> [!Note]
> По умолчанию все клиенты получают политику шлюза. Это поведение можно задать с помощью параметра клиента [Разрешить клиентам использовать шлюз управления облачными клиентами](../../deploy/about-client-settings.md#enable-clients-to-use-a-cloud-management-gateway).

Клиент Configuration Manager автоматически определяет, находится ли он в интрасети или в Интернете. Если клиент может связаться с контроллером домена или локальной точкой управления, он задает в качестве типа подключения **Интрасеть в данный момент**. В противном случае он переключается на подключение **Интернет в данный момент** и использует расположение службы шлюза управления облачными клиентами для взаимодействия с сайтом.

>[!NOTE]
> Можно задать принудительное использование шлюза клиентом независимо от того, находится ли он в интрасети или Интернете. Такая конфигурация удобна для тестирования или для клиентов, для которых требуется настроить принудительное использование шлюза управления облачными клиентами. Задайте следующий раздел реестра на клиенте:
>
> `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\CCM\Security, ClientAlwaysOnInternet = 1`
>
> Этот параметр можно также указать во время установки клиента с помощью свойства [CCMALWAYSINF](../../deploy/about-client-installation-properties.md#ccmalwaysinf).
>
> Этот параметр всегда будет применяться, даже если клиент перемещается в расположение, где в противном случае конфигурации групп границ будут использовать локальные ресурсы.


Чтобы проверить наличие на клиентах политики, задающей шлюз управления, откройте командную строку Windows PowerShell с правами администратора на клиентском компьютере и выполните следующую команду: `Get-WmiObject -Namespace Root\Ccm\LocationServices -Class SMS_ActiveMPCandidate | Where-Object {$_.Type -eq "Internet"}`

Эта команда отображает все интернет-точки управления, о которых известно клиенту. Хотя шлюз управления облачными клиентами технически не является интернет-точкой управления, клиенты рассматривают его именно так.

> [!Note]  
> Для устранения неполадок с клиентским трафиком шлюза используйте журналы **CMGHttpHandler.log**, **CMGService.log** и **SMS_Cloud_ProxyConnector.log**. Дополнительные сведения см. в [файлах журнала](../../../plan-design/hierarchy/log-files.md#cloud-management-gateway).


## <a name="modify-a-cmg"></a>Изменение шлюза управления облачными клиентами

После создания шлюза вы можете изменить некоторые его параметры. Выберите шлюз в консоли Configuration Manager, а затем выберите пункт **Свойства**. Настройте параметры на следующих вкладках.  

#### <a name="general"></a>Общие

- **Сертификат управления Azure**: измените сертификат управления Azure для шлюза управления облачными клиентами. Этот параметр удобен при обновлении сертификата до истечения срока его действия.  

#### <a name="settings"></a>"Настройки"

- **Файл сертификата**: измените сертификат проверки подлинности сервера для шлюза. Этот параметр удобен при обновлении сертификата до истечения срока его действия.  

- **Экземпляр виртуальной машины**: измените число виртуальных машин, используемых службой в Azure. Этот параметр позволяет динамически масштабировать службу в зависимости от уровня использования или затрат.  

- **Сертификаты**: добавьте или удалите сертификаты доверенного корневого или промежуточного ЦС. Этот параметр удобен при добавлении новых ЦС или списании просроченных сертификатов.  

- **Проверять отзыв сертификата клиента**: если вы изначально не включили этот параметр при создании шлюза, его можно включить после публикации списка отзыва сертификатов. Дополнительные сведения см. в разделе [Публикация списка отзыва сертификатов](security-and-privacy-for-cloud-management-gateway.md#bkmk_crl).  

- **Разрешить шлюзу управления облачными клиентами функционировать как облачной точке распространения и предоставлять содержимое из службы хранилища Azure**. Начиная с версии 1806, данный параметр включен по умолчанию. Теперь шлюз управления облачными клиентами может предоставлять содержимое клиентам. Эта возможность сокращает число необходимых сертификатов и затраты на виртуальные машины Azure.<!--1358651-->  

#### <a name="alerts"></a>Предупреждения

Оповещения можно перенастроить в любое время после создания шлюза.


### <a name="redeploy-the-service"></a>Повторное развертывание службы

Более значительные изменения, например следующие настройки, требуют повторного развертывания службы:

- Замена классической модели развертывания моделью Azure Resource Manager
- Подписка
- Имя службы
- Замена закрытых ключей открытыми (PKI)
- Регион

Всегда сохраняйте по крайней мере один активный шлюз управления облачными клиентами, чтобы интернет-клиенты могли получать обновленную политику. Интернет-клиенты не могут взаимодействовать с удаленным шлюзом. Клиентам не будет известно о новом шлюзе, пока они не вернутся в интрасеть. При создании второго экземпляра шлюза для удаления первого необходимо также создать другую точку подключения шлюза.

Клиенты по умолчанию обновляют политику каждые 24 часа, таким образом, после создания нового шлюза необходимо подождать хотя бы одни сутки, прежде чем удалять старый шлюз. Если клиенты будут выключены или у них не будет подключения к Интернету, может потребоваться больше времени.

При наличии существующего шлюза управления облачными клиентами в классической модели развертывания необходимо развернуть новый шлюз для использования метода развертывания Azure Resource Manager.<!--509753--> Существует два варианта.  

- Если вы хотите повторно использовать то же имя службы, выполните следующие действия.  

    1. Сначала удалите классический шлюз управления облачными клиентами, принимая во внимание рекомендацию всегда иметь по крайней мере один активный шлюз для интернет-клиентов.  

    2. Создайте новый шлюз с помощью модели развертывания Azure Resource Manager. Используйте тот же сертификат проверки подлинности сервера.  

    3. Перенастройте точку подключения шлюза управления облачными клиентами для использования нового экземпляра шлюза.  

- Если вы хотите использовать новое имя службы, выполните следующие действия.  

    1. Создайте новый шлюз с помощью модели развертывания Azure Resource Manager. Используйте новый сертификат проверки подлинности сервера.  

    2. Создайте новую точку подключения шлюза управления облачными клиентами и свяжите ее с новым шлюзом.  

    3. Подождите по крайней мере один день, чтобы интернет-клиенты могли получить политику о новом шлюзе.  

    4. Удалите классический шлюз управления облачными клиентами.  

> [!Tip]  
> Чтобы определить текущую модель развертывания шлюза управления облачными клиентами, выполните указанные ниже действия.<!--SCCMDocs issue #611-->  
>
> 1. В консоли Configuration Manager перейдите в рабочую область **Администрирование**, разверните узел **Облачные службы** и выберите узел **Шлюз управления облачными клиентами**.  
> 2. Выберите экземпляр шлюза управления облачными клиентами.  
> 3. В области сведений в нижней части окна найдите атрибут **Модель развертывания**. Для развертывания с помощью Resource Manager этот атрибут имеет значение **Azure Resource Manager**. Устаревшая модель развертывания с помощью сертификата управления Azure отображается как **Azure Service Manager**.
>
> Вы также можете добавить атрибут **Модель развертывания** в качестве столбца в представление списка.  

### <a name="modifications-in-the-azure-portal"></a>Изменения на портале Azure

Шлюз можно изменять только в консоли Configuration Manager. Внесение изменений в службу или базовую виртуальную машину напрямую в Azure не поддерживается. Любые изменения могут быть утрачены без предварительного уведомления. Как и в случае с любой другой моделью PaaS, служба может перестроить виртуальные машины в любое время. Такие перестроения могут выполняться для обслуживания серверного оборудования, а также для применения обновлений к операционной системе виртуальной машины.

### <a name="delete-the-service"></a>Удаление службы

Если вам потребуется удалить шлюз, это также нужно сделать в консоли Configuration Manager. Удаление всех компонентов в Azure вручную приведет к несогласованности системы. В этом случае остаются потерянные данные и может возникнуть непредвиденное поведение.


## <a name="next-steps"></a>Дальнейшие шаги

- [Мониторинг клиентов для шлюза управления облаком](monitor-clients-cloud-management-gateway.md)
- [Часто задаваемые вопросы о шлюзе управления облачными клиентами](cloud-management-gateway-faq.md)
