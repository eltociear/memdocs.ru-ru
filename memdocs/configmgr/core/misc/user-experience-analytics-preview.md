---
title: Аналитика конечных точек (предварительная версия)
titleSuffix: Configuration Manager
description: Инструкции по аналитике конечной точки (предварительная версия).
ms.date: 05/11/2020
ms.prod: configuration-manager
ms.technology: configmgr-analytics
ms.topic: conceptual
ms.assetid: 00537b90-f6d2-45e9-a9a1-6b3ada466a16
author: mestew
ms.author: mstewart
manager: dougeby
ROBOTS: NOINDEX, NOFOLLOW
ms.openlocfilehash: c7a99931db27b6a55c9e0722cc12c1d7a9cc9e80
ms.sourcegitcommit: 9a700a72735f9a316bdb51c44f86f9cc3bfb7be2
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/21/2020
ms.locfileid: "83764243"
---
# <a name="endpoint-analytics-preview"></a><a name="bkmk_uea"></a> Аналитика конечных точек (предварительная версия)

> [!Note]  
> Эти сведения относятся к предварительной версии функции, которая может значительно измениться перед коммерческим выпуском. Корпорация Майкрософт не предоставляет никаких гарантий, явных или подразумеваемых, относительно предоставленной здесь информации. 
>
> Дополнительные сведения об изменениях в службе аналитики конечных точек см. в разделе [Новые возможности в службе "Аналитика конечных точек"](whats-new-endpoint-analytics.md). 
>
>Если вы хотите присоединиться к пользователям закрытой предварительной версии Аналитики конечных точек, введите сведения [в этой форме](https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR9-ZzmlTlbJMh03eDDHtO81UOERLUkMzNFZKSlBaNFNFUVhFSlE0MzNYMS4u). Доступ к клиентам будет передаваться в виде каналов для работы с развертываниями предварительной версии.


## <a name="endpoint-analytics-overview"></a>Общие сведения о службе "Аналитика конечных точек"

Нередко пользователи сталкиваются с длительной загрузкой или другими перерывами в работе. Эти перерывы могут быть вызваны сочетаниями таких факторов:

- устаревшее оборудование;
- не оптимизированные для взаимодействия с пользователем конфигурации программного обеспечения;
- проблемы, вызванные изменениями и обновлениями конфигурации.

Эти и другие проблемы, с которыми сталкиваются пользователи, существуют из-за того, что ИТ-служба не имеет достаточного представления о работе пользователей. Как правило, единственной возможностью увидеть эти проблемы является использование низкоскоростного дорогостоящего канала поддержки, который обычно не предоставляет четкой информации о том, что нужно оптимизировать. Расходы, связанные с этими проблемами, ложатся не только на службу поддержки ИТ. Сведения о времени, затрачиваемом работниками на решение проблем, также дорогостоящие. Проблемы, связанные с производительностью, надежностью и поддержкой, которые снижают производительность пользователей, могут оказать большое влияние на итоговые результаты организации.

**Аналитика конечных точек** нацелена на повышение производительности работы пользователей и сокращение затрат на поддержку, параллельно предоставляя полезные сведения о работе пользователей. Эти полезные сведения позволяют ИТ-службе оптимизировать работу пользователей благодаря профилактической поддержке и обнаруживать регрессию во взаимодействии с пользователем, оценивая влияние изменений в конфигурации на пользователя.

В этом первом выпуске основное внимание уделяется трем задачам.

- [**Рекомендуемое программное обеспечение**](#bkmk_uea_rs): рекомендации по обеспечению оптимальной работы пользователей.
- [**Написание скриптов с предупредительными мерами**](#bkmk_uea_prs): устранение общих проблем с поддержкой до того, как пользователи заметят их.
- [**Производительность запуска**](#bkmk_uea_bp): помогает ИТ-службе ускорить переход пользователей от включения до начала продуктивной работы без длительных задержек при загрузке и входе.

Этот выпуск — только начало! Вскоре после первоначального выпуска мы быстро предоставим новые полезные сведения для других ключевых аспектов взаимодействий с пользователем. Дополнительные сведения об изменениях в службе аналитики конечных точек см. в разделе [Новые возможности в службе "Аналитика конечных точек"](whats-new-endpoint-analytics.md).

## <a name="getting-started"></a><a name="bkmk_uea_prereq"></a> Начало работы

Чтобы начать работу с Аналитикой конечных точек, проверьте предварительные требования, а затем начните сбор данных. 

### <a name="technical-prerequisites"></a>Технические предварительные требования

Устройства для использования этой предварительной версии можно зарегистрировать с помощью Configuration Manager или Microsoft Intune. 

Чтобы зарегистрировать устройства для использования этой предварительной версии с помощью Intune, требуется:
- Зарегистрированные в Intune устройства под управлением Windows 10.
- Аналитика производительности при запуске доступна только для устройств под управлением Windows 10 Корпоративная версии 1903 или более поздней (выпуски Домашняя и Pro в настоящее время не поддерживаются). Кроме того, устройства должны быть присоединены к среде Azure AD или гибридной среде Azure AD. Компьютеры, присоединенные к рабочей области, в настоящее время не поддерживаются.
- Сетевое подключение между устройствами и общедоступным облаком Майкрософт. Дополнительные сведения см. в разделе о [конечных точках](#bkmk_uea_endpoints).
- Чтобы [начать сбор данных](#bkmk_uea_start), требуется [роль администратора службы Intune](https://docs.microsoft.com/intune/fundamentals/role-based-access-control).
   - Нажимая кнопку **Пуск**, вы соглашаетесь с тем, что данные клиента могут храниться за пределами расположения, выбранного при подготовке клиента Microsoft Intune.
   - После нажатия кнопки **Запустить** для сбора данных другие роли, которым предоставлено разрешение только на чтение, смогут просматривать данные.

Чтобы зарегистрировать устройства для использования этой предварительной версии с помощью Configuration Manager, требуется:
- Configuration Manager версии 2002 или более новой
- Клиенты, обновленные до версии 2002 или более новой
- [Подключение клиента Microsoft Endpoint Manager](https://docs.microsoft.com/mem/configmgr/tenant-attach/device-sync-actions) с расположением клиента Azure в Северной Америке или Европе (в ближайшее время поддержка будет расширена и на другие регионы)

Независимо от того, зарегистрированы ли устройства с помощью Intune или Configuration Manager, [**упреждающие сценарии исправления**](#bkmk_uea_prs) должны соответствовать следующим требованиям:
- Устройства должны быть присоединены к среде Azure AD или гибридной среде Azure AD, а также соответствовать одному из приведенных ниже условий.
- Устройство с Windows 10 Корпоративная, Профессиональная или для образовательных учреждений, управляемое службой Intune.
- [Совместно управляемое](../../comanage/overview.md) устройство под управлением Windows 10 Корпоративная версии 1607 или более поздней с [клиентскими приложениями](../../comanage/workloads.md#client-apps), на которые указывает Intune.
- [Совместно управляемое](../../comanage/overview.md) устройство под управлением Windows 10 Корпоративная версии 1903 или более поздней с [клиентскими приложениями](../../comanage/workloads.md#client-apps), на которые указывает Configuration Manager.

### <a name="licensing-prerequisites"></a>Предварительные требования для лицензирования

Аналитика конечных точек включена в следующие планы. 

- [Enterprise Mobility + Security (план E3)](https://www.microsoftvolumelicensing.com/ProductResults.aspx?doc=Product%20Terms,OST&fid=51) или план более высокого уровня
- [Microsoft 365 корпоративный (план E3)](https://www.microsoft.com/en-us/microsoft-365/enterprise?rtc=1) или план более высокого уровня.

Для упреждающего исправления также требуется одна из следующих лицензий для управляемых устройств:
- Windows 10 Корпоративная E3 или E5 (включено в Microsoft 365 F3, E3 или E5).
- Windows 10 для образовательных учреждений A3 или A5 (включено в Microsoft 365 A3 или A5).
- Доступ к Виртуальному рабочему столу Windows E3 или E5.

### <a name="permissions"></a>Разрешения

#### <a name="endpoint-analytics-permissions"></a>Разрешения для аналитики конечных точек

Для аналитики конечных точек используются следующие разрешения:
- **Чтение** в разделе **Конфигурация устройств**;
- **Чтение** в разделе **Организация**; <!--temporary for pp-->
- разрешения, соответствующие роли пользователя, в категории **Аналитика конечных точек**.

Пользователю с доступом только для чтения потребуется только разрешение на **чтение** как в категории **Конфигурация устройств**, так и в категории **Аналитика конечных точек**. Администратору Intune обычно нужны все разрешения.

#### <a name="proactive-remediations-permissions"></a>Разрешения для предупредительных мер

Для предупредительных мер пользователю нужны разрешения, соответствующие его роли, в категории **Конфигурация устройств**.  Разрешения в категории **Аналитика конечных точек** не требуются, если пользователь использует только предупредительные меры.

Для подтверждения требований к лицензированию перед первым использованием упреждающего исправления необходим [администратор службы Intune](https://docs.microsoft.com/azure/active-directory/users-groups-roles/directory-assign-admin-roles#intune-service-administrator-permissions).

## <a name="start-gathering-data"></a><a name="bkmk_uea_start"></a> Запуск сбора данных
- Если вы регистрируете только управляемые устройства Intune, перейдите к разделу [Регистрация на портале аналитики для конечных точек](#bkmk_uea_onboard).

- Если вы регистрируете устройства, управляемые через Configuration Manager, необходимо выполнить следующие действия.
   - [Включение сбора данных аналитики конечных точек в Configuration Manager](#bkmk_uea_cm_enroll)
   - [Включение отправки данных в Configuration Manager](#bkmk_uea_cm_upload)
   - [Регистрация на портале аналитики для конечных точек](#bkmk_uea_onboard)  

### <a name="enroll-devices-managed-by-configuration-manager"></a><a name="bkmk_uea_cm_enroll"></a> Регистрация устройств, управляемых через Configuration Manager
<!--6051638, 5924760-->
Прежде чем регистрировать устройства Configuration Manager, убедитесь в соблюдении всех [предварительных требований](#bkmk_uea_prereq), включая [присоединение клиента Microsoft Endpoint Manager](https://docs.microsoft.com/mem/configmgr/tenant-attach/device-sync-actions). 

#### <a name="enable-endpoint-analytics-data-collection-in-configuration-manager"></a><a name="bkmk_uea_cm_enable"></a> Включение сбора данных аналитики конечных точек в Configuration Manager

1. В консоли Configuration Manager последовательно выберите **Администрирование** > **Параметры клиента** > **Параметры клиента по умолчанию**.
1. Щелкните правой кнопкой мыши и выберите **Свойства**, а затем откройте раздел свойств **Агент компьютера**.
1. Для параметра **Enable Endpoint analytics data collection** (Включить сбор данных аналитики конечных точек) укажите значение **Да**.
   > [!Important] 
   > Если у вас есть настраиваемая конфигурация для агента клиента, которая уже развернута на устройствах, обязательно измените в этой конфигурации параметр **Enable Endpoint analytics data collection** (Включить сбор данных аналитики конечных точек) и повторно разверните ее на компьютерах, чтобы изменения вступили в силу.

#### <a name="enable-data-upload-in-configuration-manager"></a><a name="bkmk_uea_cm_upload"></a> Включение отправки данных в Configuration Manager

1. В консоли Configuration Manager последовательно выберите **Администрирование** > **Облачные службы** > **Совместное управление**.
1. Выберите элемент **CoMgmtSettingsProd** и нажмите **Свойства**.
1. На вкладке **Configure upload** (Настройка отправки) установите флажок **Enable Endpoint analytics for devices uploaded to Microsoft Endpoint Manager** (Включить аналитику конечных точек для устройств, данные которых отправляются в Microsoft Endpoint Manager).

   :::image type="content" source="media/6051638-configure-upload-configmgr.png" alt-text="Включение аналитики конечных точек для устройств, данные которых отправляются в Microsoft Endpoint Manager" lightbox="media/6051638-configure-upload-configmgr.png":::

### <a name="onboard-in-the-endpoint-analytics-portal"></a><a name="bkmk_uea_onboard"></a> Регистрация на портале аналитики для конечных точек
Регистрация на портале аналитики для конечных точек является обязательной для устройств под управлением Configuration Manager и Intune.

1. Перейдите на страницу `https://endpoint.microsoft.com/#blade/Microsoft_Intune_Enrollment/UXAnalyticsMenu`.
1. Нажмите кнопку **Запустить**. При этом будет автоматически назначен профиль конфигурации для получения данных о производительности загрузки со всех соответствующих устройств. Можно [изменить назначенные устройства](#bkmk_uea_profile) позже. Заполнение данных о производительности при запуске с устройств, зарегистрированных в Intune, может занять до 24 часов после их перезагрузки.
   - Дополнительные сведения об общих проблемах см. в разделе [Устранение неполадок регистрации устройств при запуске](#bkmk_uea_enrollment_tshooter).

## <a name="overview-page"></a>Страница "Обзор"

Когда данные будут готовы, вы заметите некоторые сведения на странице **Обзор**, более подробно описанные ниже.

- **Оценка работы пользователей** — это взвешенное среднее значение 50/50 от пунктов **Рекомендованное программное обеспечение** и **Оценки производительности запуска**. Со временем мы будем расширять набор подсчетов.

- Вы можете сравнить текущую оценку с другими оценками, задав контрольное значение.
  - Как описано в разделе о [контрольном значении](#bkmk_uea_baselines), для *коммерческой медианы* существует встроенное контрольное значение, благодаря которому можно сравнить свое предприятие с типичным. Вы можете создавать новые контрольные значения на основе текущих метрик, чтобы со временем отслеживать ход выполнения или просматривать регрессии.
   - Маркеры контрольных значений отображаются для общей оценки и подсчетов. Если какая-либо из оценок уменьшилась больше, чем на настраиваемый порог от выбранного контрольного значения, оценка отображается красным цветом, а оценка верхнего уровня помечается как требующая внимания.
  - Состояние **Недостаточно данных** означает, что у вас нет достаточного количества устройств для предоставления информативной оценки. В настоящее время требуется по крайней мере пять устройств.

- **Фильтры** позволяют просматривать оценки на подмножестве устройств или пользователей. Однако в этой предварительной версии функция фильтрации не включена.

- **Аналитика и рекомендации** являются приоритетным списком для улучшения оценки. Этот список фильтруется по контексту подузла при переходе к пунктам **Рекомендации** или **Рекомендуемое программное обеспечение**.

[![Страница "Обзор" аналитики конечных точек](media/overview-page.png)](media/overview-page.png#lightbox)

## <a name="recommended-software"></a><a name="bkmk_uea_rs"></a>Рекомендуемое программное обеспечение

> [!Important]  
> Аналитика конечных точек рассчитывает оценку **Внедрение программного обеспечения** для всех устройств, управляемых Intune, независимо от того, зарегистрированы они в службе "Аналитика конечных точек", или нет.

Известно, что некоторое программное обеспечение улучшает работу пользователей и не зависит от метрик работоспособности нижнего уровня Например, Windows 10 имеет более высокий уровень индекса потребительской лояльности, чем Windows 7. Оценка за **внедрение программного обеспечения** — это число от 0 до 100, представляющее взвешенное среднее значение от процента устройств, на которых развернуто различное рекомендованное программное обеспечение. Текущая оценка для Windows выше, чем для других метрик, так как пользователи часто взаимодействуют с ними. Метрики описаны ниже. 

[![Страница "Рекомендуемое программное обеспечение" аналитики конечных точек](media/recommended-software.png)](media/recommended-software.png#lightbox)

### <a name="windows-10"></a><a name="bkmk_uea_win10"></a> Windows 10

Windows 10 обеспечивает лучшее взаимодействие с пользователем по сравнению с более старыми версиями Windows. Дополнительные сведения см. в [Докладе TEI](https://vc2prod.blob.core.windows.net/vc-resources/TEIStudies/TEI%20of%20Windows%2010.pdf).

Эта метрика измеряет процент устройств под управлением Windows 10 по сравнению с более старыми версиями Windows.

Рекомендуемое действие по исправлению при переходе устройств из предыдущих версий Windows — создание плана развертывания с помощью [Аналитики компьютеров](../../desktop-analytics/overview.md).

### <a name="autopilot"></a><a name="bkmk_uea_ap"></a> Автопилот

Microsoft Autopilot предоставляет более простую начальную подготовку для компьютеров под управлением Windows 10 по сравнению со встроенным интерфейсом, уменьшая количество экранов при первом включении и предоставляя значения по умолчанию, чтобы обеспечить правильную подготовку устройства сотрудника при первой настройке или после сброса.

Эта метрика измеряет процент устройств Windows 10, зарегистрированных в Autopilot.

Рекомендуемое действие исправления — зарегистрировать существующие устройства в Автопилоте с помощью [Microsoft Intune](https://docs.microsoft.com/intune/enrollment-autopilot).

### <a name="azure-active-directory"></a><a name="bkmk_uea_aad"></a> Azure Active Directory

Azure Active Directory (Azure AD) предоставляет пользователям множество преимуществ для повышения производительности, включая единый вход на уровне устройства в приложения и службы, вход Windows Hello, самостоятельное восстановление BitLocker и перемещение корпоративных данных.

Эта метрика измеряет процент устройств, зарегистрированных в Azure AD.

Устройства под управлением Microsoft-Intune уже зарегистрированы в Azure AD. Рекомендуемое действие по исправлению для устройств, управляемых с помощью Configuration Manager, — либо [их регистрация в Azure AD](https://docs.microsoft.com/azure/active-directory/devices/hybrid-azuread-join-managed-domains), либо [совместное управление ими](../../comanage/overview.md). Совместное управление устройствами также улучшает оценку управления облаком.

### <a name="cloud-management"></a><a name="bkmk_uea_intune"></a> Управление облачными клиентами

Microsoft Intune предоставляет пользователям несколько преимуществ для повышения производительности, включая доступ к корпоративным ресурсам даже вне корпоративной сети и отсутствие издержек, связанных с групповой политикой, что позволяет улучшить опыт конечного пользователя. Эта метрика измеряет процент компьютеров, зарегистрированных в Microsoft Intune. Узнайте, как [Майкрософт предоставляет эти функции наших сотрудникам](https://www.microsoft.com/en-us/itshowcase/managing-windows-10-devices-with-microsoft-intune).

Рекомендуемое действие по исправлению для устройств, управляемых с помощью Configuration Manager и еще не зарегистрированных в Intune — [совместное управление ими](../../comanage/overview.md).

### <a name="no-commercial-median"></a><a name="bkmk_uea_np"></a> Без коммерческой медианы

Встроенные контрольные значения **коммерческих медиан** в настоящее время не имеют метрик для подсчетов, перечисленных в разделах выше.

## <a name="startup-performance"></a><a name="bkmk_uea_bp"></a> Производительность при запуске

> [!NOTE]
> Если отображаются данные по производительности при запуске не со всех устройств, см. раздел [Устранение неполадок регистрации устройств при запуске](#bkmk_uea_enrollment_tshooter).

Оценка продуктивности при запуске помогает ИТ-службе ускорить переход пользователей от включения до получения продуктивности без длительных задержек при загрузке и входе. **Оценка запуска** — число от 0 до 100. Эта оценка представляет собой взвешенное среднее значение **Оценки загрузки** и **Оценки входа**, которые вычисляются следующим образом:

- **Оценка загрузки**. Основывается на времени от включения до входа в систему. Мы рассмотрим время последней загрузки с каждого устройства, исключая фазу обновления, а затем оценим его от 0 (плохое) до 100 (исключительное). Эти показатели оцениваются по среднему значению, чтобы обеспечить общую оценку загрузки клиента.
- **Оценка входа**. Основывается на времени с момента ввода учетных данных до момента доступности рабочего стола (рабочий стол отрисован, и загрузка ЦП держалась на уровне ниже 50 % по крайней мере 2 секунды). Мы смотрим на время последнего входа в каждое устройство, исключая первые входы или входы сразу после обновления компонента, а затем оцениваем его от 0 (плохое) до 100 (исключительное). Эти показатели оцениваются по среднему значению, чтобы обеспечить общую оценку загрузки клиента.

[![Страница "Производительность при запуске" аналитики конечных точек](media/startup-performance.png)](media/startup-performance.png#lightbox)

### <a name="insights"></a>Подробные сведения

На странице **Производительность при запуске** также приводится упорядоченный список **Аналитика и рекомендации**, описанные в следующих разделах.

#### <a name="hard-disk-drives"></a><a name="bkmk_uea_hdd"></a> Жесткие диски

Производительность при запуске предоставляет полезные сведения о количестве устройств, на которых загрузочный диск является жестким диском. Как правило, система загружается в три-четыре раза дольше с жестких дисков, чем с твердотельных накопителей. Мы также сообщаем об ожидаемом улучшении производительности при запуске, которое вы можете получить, перейдя на твердотельные накопители.

Щелкните, чтобы просмотреть список устройств с жесткими дисками. Рекомендуемое действие — замена этих устройств твердотельными накопителями.

#### <a name="group-policy"></a><a name="bkmk_uea_gp"></a> Групповая политика

Производительность при запуске позволяет получить сведения о количестве устройств, на которых существуют задержки при загрузке и входе, вызванные групповой политикой. После щелчка мышью откроется представление устройств. Вид отсортирован по времени групповой политики, так что вы сможете увидеть затронутые устройства, для которых следует выполнить устранение неполадок.

Щелкнув конкретное устройство, можно просмотреть его историю загрузки и входов в систему. Журнал помогает определить, является ли данная ошибка регрессией, и когда она могла возникнуть.

Несмотря на наличие множества статей об оптимизации производительности групповых политик, вы можете перейти на облачное управление. Переход на облачное управление позволяет использовать [базовые требования безопасности Intune](https://docs.microsoft.com/intune/protect/security-baselines) и средство Аналитики политик, которое будет выпущено уже скоро.

#### <a name="slow-boot-and-sign-in-times"></a><a name="bkmk_uea_sb"></a> Медленные загрузка и вход в систему

Производительность при запуске обеспечивает сведения о количестве устройств с медленной загрузкой или входом в систему. Если оценка загрузки или входа — "0", это означает, что устройство работает слишком медленно. После щелчка мышью откроется представление устройств. Устройства сортируются по основному времени загрузки или основному времени входа, так что вы сможете увидеть затронутые устройства, для которых нужно выполнить устранения неполадок.

Щелкнув конкретное устройство, можно просмотреть его историю загрузки и входов в систему. Журнал помогает определить, была ли данная ошибка регрессией и когда она могла возникнуть.

### <a name="reporting-tabs"></a>Вкладки отчетов

На странице **Производительность при запуске** имеются вкладки отчетов, на которых приводятся аналитические сведения.
1. **Производительность модели**. На этой вкладке приводятся данные по производительности при загрузке и входе по моделям устройств. С их помощью можно определить, связаны ли проблемы производительности с конкретными моделями.
1. **Производительность устройства**. На этой вкладке представлены метрики загрузки и входа для всех устройств. Можно выполнить сортировку по определенной метрике (например, времени входа GP), чтобы узнать, какие устройства имеют наихудшие значения этой метрики. Это может помочь в устранении неполадок. Кроме того, можно выполнить поиск устройства по имени. Щелкнув устройство, можно просмотреть его историю загрузки и входов в систему. Таким образом можно узнать, снизилась ли производительность за последнее время.
1. **Процессы запуска**. Процессы запуска могут негативно повлиять на работу пользователей, увеличивая время ожидания, в течение которого пользователи должны ждать, пока рабочий стол начнет отвечать на запросы. На этой вкладке (если она отображается — пока мы предоставили ее лишь некоторым клиентам, так как все еще работаем над этой функцией) показано, какие процессы влияют на этап входа до доступности рабочего стола, который продолжается с момента отрисовки рабочего стола и до тех пор, пока загрузка ЦП остается выше 50 %. В таблице перечислены процессы, которые влияют минимум на 10 устройств в клиенте.  

## <a name="proactive-remediations"></a><a name="bkmk_uea_prs"></a> Предупредительные меры

Предупредительные меры — это пакеты сценариев, которые можно использовать для обнаружения и исправления распространенных проблем поддержки на устройстве пользователя, даже до того, как пользователь осознает, что возникла проблема. Эти исправления могут помочь снизить количество обращений в службу поддержки. Вы можете создать собственный пакет сценариев или развернуть один из пакетов сценариев, написанных и используемых в нашей среде для сокращения количества запросов в службу поддержки.

Каждый пакет сценариев состоит из сценария обнаружения, сценария исправления и метаданных. Вы сможете развертывать эти пакеты сценариев и просматривать отчеты по их эффективности, используя Intune. Мы активно разрабатываем новые пакеты сценариев и хотели бы узнать ваши впечатления от их использования. Если у вас есть отзывы о пакетах сценариев, свяжитесь с контактным лицом предварительной версии аналитики конечных точек.

### <a name="get-the-detection-and-remediation-scripts"></a><a name="bkmk_uea_prs_ps1"></a> Получение сценариев обнаружения и исправления

1. Скопируйте сценарии из нижней части этой статьи в разделе [Сценарии PowerShell](#bkmk_uea_ps_scripts).
    - Файлы сценариев, имена которых начинаются с `det`, являются сценариями обнаружения. Сценарии исправления начинаются с `rem`.
    - Описание сценариев см. в разделе [Описание сценариев](#bkmk_uea_scripts).
1. Сохраните каждый сценарий, используя предоставленное имя. Имя также можно увидеть в комментариях в верхней части каждого сценария.
    - Вы можете использовать другое имя сценария, но оно не будет совпадать с именем, указанным в разделе [Описание сценариев](#bkmk_uea_scripts).


### <a name="deploying-and-monitoring-scripts"></a><a name="bkmk_uea_prs_deploy"></a> Развертывание и мониторинг сценариев
Служба **Расширение управления Microsoft Intune** получает скрипты из Intune и запускает их. Скрипты повторно выполняются каждые 24 часа. Чтобы развернуть и отслеживать скрипты, следуйте приведенным ниже инструкциям.

1. Перейдите в узел **Предупредительные меры** в консоли.
1. Чтобы создать пакет сценария, нажмите кнопку **Создать пакет сценария**.
     [![Страница "Предупредительные меры" аналитики конечных точек. Выберите ссылку создания.](media/proactive-remediations-create.png)](media/proactive-remediations-create.png#lightbox)
1. На шаге **Основные сведения** присвойте пакету сценариев **имя** и (необязательно) **описание**. Поле **Издатель** можно изменить, но по умолчанию используется имя клиента. **Версию** невозможно изменить. 
1. На шаге **Параметры** скопируйте текст из скачанного сценария в поля **Сценарий обнаружения** и **Сценарий исправления**. 
   - Соответствующие сценарии обнаружения и исправления должны находиться в одном пакете. Например, сценарий обнаружения `Detect_stale_Group_Policies.ps1` соответствует сценарию исправления `Remediate_stale_GroupPolicies.ps1`.
       [![Страница параметров сценария "Предупредительные меры" конечных точек.](media/proactive-remediations-script-settings.png)](media/proactive-remediations-script-settings.png#lightbox)
1. Заполните параметры на странице **Параметры** следующими рекомендуемыми конфигурациями:
   - **Запуск сценария с использованием текущих учетных данных**. Зависит от сценария. Дополнительные сведения см. в разделе [Описание сценариев](#bkmk_uea_scripts).
   - **Принудительно проверить подпись сценария**. Нет
   - **Запуск сценария на 64-разрядном PowerShell**. Нет
1. Щелкните **Далее**, затем назначьте все необходимые **Теги области**.
1. На шаге **Назначения** выберите группы устройств, в которых требуется развернуть пакет сценария.
1. Выполните шаг **Review + Create** (Проверка и создание) для развертывания.
1. В разделе **Отчеты** > **Аналитика конечных точек — Предупредительные меры** можно просмотреть общие сведения о состоянии обнаружения и исправления.
       [![Отчет "Аналитика конечных точек — Предупредительные меры", страница "Обзор".](media/proactive-remediations-report-overview.png)](media/proactive-remediations-report-overview.png#lightbox)
1. Щелкните **Состояние устройства**, чтобы получить сведения о состоянии каждого устройства в развертывании.
       [!["Состояние устройства" в разделе "Предупредительные меры" аналитики конечных точек.](media/proactive-remediations-device-status.png)](media/proactive-remediations-device-status.png#lightbox)


## <a name="endpoint-analytics-settings"></a><a name="bkmk_uea_set"></a> Настройки аналитики конечных точек

На странице параметров можно выбрать **Общие** или **Базовые показатели**. Каждый из этих параметров описан ниже.

### <a name="general"></a><a name="bkmk_uea_gen"></a> Общие

Вкладка **Общие** на странице **Параметры** позволяет узнать, включен ли сбор данных о производительности запуска Intune. Он автоматически включается для всех устройств по умолчанию при нажатии кнопки **Пуск** для включения аналитики работы пользователей. Вы можете перейти к узлу "Политика сбора данных Intune", чтобы изменить набор устройств, на которых создаются записи о загрузке и входе.


#### <a name="intune-data-collection-policy"></a><a name="bkmk_uea_profile"></a> Политика сбора данных Intune

Чтобы назначить этот параметр подмножеству устройств, [создайте профиль](/intune/configuration/device-profile-create#create-the-profile) со следующими сведениями: 

  - **Имя** — введите описательное имя профиля, например **Политика сбора данных Intune**
   
  - **Описание**. Введите описание профиля. Этот параметр является необязательным, но мы рекомендуем его использовать.
    
  - **Платформа**. Выберите **Windows 10 и более поздних версий**.
   
  - **Тип профиля**. Выберите **Мониторинг работоспособности Windows**
   
  - Настройте **параметры**:
   
       - **Мониторинг работоспособности**: Выберите **Включить** для сбора сведений о событиях с устройств Windows 10
    
    - **Область действия**: Выберите **Производительность загрузки** 

  - Используйте [Теги области](/intune/configuration/device-profile-create#scope-tags) и [Правила применимости](/intune/configuration/device-profile-create#applicability-rules) для фильтрации профиля по определенным ИТ-группам или устройствам в группе, соответствующей определенным критериям.

> [!NOTE]
> Существует заполнитель для указания инструкций по настройке соединителя данных Configuration Manager. Однако эта функция не реализована в этой исходной предварительной версии.

  [![Страница "Общие параметры" аналитики конечных точек](media/settings-general.png)](media/settings-general.png#lightbox)

### <a name="baseline-management"></a><a name="bkmk_uea_baselines"></a> Управление контрольными значениями

Вы можете сравнить текущие оценки и подсчеты с другими оценками, задав контрольное значение.

1. Для **коммерческой медианы** существует встроенное контрольное значение, которое позволяет сравнить оценки вашего предприятия с типичным.
1. Вы можете создавать новые контрольные значения на основе текущих метрик, чтобы со временем отслеживать ход выполнения или просматривать регрессии. Нажмите кнопку **Создать новый** и присвойте новому контрольному значению имя. Рекомендуется использовать имя, которое содержит дату, поскольку это упрощает выбор из раскрывающегося списка на страницах отчетов.
1. Для каждого клиента существует ограничение в 100 контрольных значений. Старые контрольные значения, которые больше не нужны, можно удалить.
1. Ваши текущие метрики будут помечены красным цветом и будут показаны как регрессивные, если упадут ниже текущего контрольного значения в отчетах. Так как колебание метрик изо дня в день является нормальным явлением, вы можете установить порог регрессии, который по умолчанию составляет 10 %. При этом пороге метрики помечаются как регрессионные только в том случае, если они регрессировали более чем на 10 %.

   [![Страница основных параметров аналитики конечных точек](media/settings-baseline.png)](media/settings-baseline.png#lightbox)

## <a name="troubleshooting"></a><a name="bkmk_uea_tshoot"></a> Устранение неполадок

Сведения в разделах ниже могут помочь при устранении неполадок, которые могут возникнуть.

### <a name="troubleshooting-startup-performance-device-enrollment"></a><a name="bkmk_uea_enrollment_tshooter"></a> Устранение неполадок регистрации устройств при запуске

Если на странице "Обзор" отображается нулевая оценка производительности при запуске, а также отображается баннер со сведениями об ожидании данных или если на вкладке "Производительность устройства при запуске" отображается меньше устройств, чем ожидалось, можно выполнить некоторые действия для устранения проблемы.

Ниже приведен краткий обзор ограничений, распространяющихся на сбор данных по производительности при запуске.
1. Устройства должны работать под управлением Windows 10 версии 1903 или более поздней.
2. Устройства должны быть присоединены к Azure AD. В настоящее время устройства, присоединенные к рабочей области, не поддерживаются, хотя мы активно изучаем возможность добавления их поддержки в Windows.
3. Устройства должны работать под управлением выпуска Windows 10 Корпоративная. Выпуски Windows 10 Домашняя и Профессиональная в настоящее время не поддерживаются, хотя мы активно изучаем возможность добавления их поддержки.

Имейте в виду, что эти проблемы не будут относиться к данным из соединителя Configuration Manager, который готовится к выпуску. Он сможет собирать данные с любого клиентского компьютера Configuration Manager независимо от версии, выпуска ОС или конфигурации каталога.

Во-вторых, ниже приведен краткий контрольный список, которым следует руководствоваться при устранении неполадок.
1. Убедитесь, что у вас есть профиль мониторинга работоспособности Windows, предназначенный для всех устройств, данные о производительности которых требуется получить. Ссылка на этот профиль находится на странице параметров аналитики конечных точек. Перейти к нему можно так же, как и к любому другому профилю Intune. Перейдите на вкладку назначения, чтобы убедиться, что профиль назначен ожидаемому набору устройств. 
1. Ознакомьтесь с тем, какие устройства были успешно настроены для сбора данных. Эти сведения можно также просмотреть на странице обзора профилей.  
   - Существует известная проблема, из-за которой клиенты могут увидеть ошибки назначения профиля, связанная с тем, что на затронутых устройствах отображается ошибка с кодом `-2016281112 (Remediation failed)`. Мы активно изучаем эту проблему.
1. Устройства, которые были успешно настроены для сбора данных, необходимо перезапустить после включения сбора данных, а затем подождать до 24 часов, чтобы устройство отобразилось на вкладке "Производительность устройства".
1. Если устройство успешно настроено для сбора данных и было впоследствии перезапущено, а спустя 24 часа вы по-прежнему не видите его, возможно, устройству не удается связаться с конечными точками коллекции. Эта проблема может возникать в случае, если в вашей компании используется прокси-сервер, а конечные точки не включены на прокси-сервере. Дополнительные сведения см. в разделе [Устранение неполадок конечных точек](#bkmk_uea_endpoints).


### <a name="endpoints"></a><a name="bkmk_uea_endpoints"></a> Конечные точки

Чтобы зарегистрировать устройства в аналитике конечных точек, необходимые функциональные данные устройств следует отправить корпорации Майкрософт. Если в среде применяется прокси-сервер, используйте эти сведения для его настройки.

Чтобы включить общий доступ к функциональным данным, настройте прокси-сервер на разрешение приведенных ниже конечных точек.

> [!Important]  
> Для обеспечения конфиденциальности и целостности данных при обмене данными с конечными точками общего доступа к функциональным данным Windows проверяет наличие SSL-сертификата корпорации Майкрософт (привязка сертификата). Перехват и проверку SSL выполнить невозможно. Чтобы использовать Аналитику конечных точек, исключите эти конечные точки из проверки SSL.<!-- BUG 4647542 -->

| Конечная точка  | Функция  |
|-----------|-----------|
| `https://*.events.data.microsoft.com` | Используется для отправки [необходимых функциональных данных](#bkmk_uea_datacollection) на конечную точку сбора данных Intune. |
| `https://graph.windows.net` | Используется для автоматического получения параметров при присоединении иерархии к Аналитике конечных точек (в роли сервера Configuration Manager). Дополнительные сведения см. в разделе [Настройки прокси-сервера для сервера системы сайта](../plan-design/network/proxy-server-support.md#configure-the-proxy-for-a-site-system-server). |
| `https://*.manage.microsoft.com` | Используется для синхронизации коллекции устройств и устройств с Аналитикой конечных точек (только для роли сервера Configuration Manager). Дополнительные сведения см. в разделе [Настройки прокси-сервера для сервера системы сайта](../plan-design/network/proxy-server-support.md#configure-the-proxy-for-a-site-system-server). |


### <a name="proxy-server-authentication"></a>Проверка подлинности прокси-сервера.

Если ваша организация использует проверку подлинности прокси-сервера для доступа к Интернету, убедитесь, что она не блокирует данные. Если прокси-сервер не разрешает устройствам передавать эти данные, они не будут отображаться в Аналитике компьютеров.

#### <a name="bypass-recommended"></a>Обход (рекомендуется)

Настройте прокси-серверы так, чтобы они не требовали проверку подлинности прокси-сервера для трафика, поступающего в конечные точки общего доступа к данным. Этот вариант является наиболее комплексным решением. Он применим для всех версий Windows 10.  

#### <a name="user-proxy-authentication"></a>Проверка подлинности прокси-сервера пользователя

Настройте устройства для использования контекста пользователя, вошедшего в систему, для проверки подлинности прокси. Для этого метода требуются следующие конфигурации:

- Устройства имеют текущее исправление для поддерживаемой версии Windows

- Настройте прокси-сервер уровня пользователя (прокси-сервер WinINET) в области **Параметры прокси-сервера** в группе "Сеть и Интернет" в параметрах Windows. Вы также можете использовать устаревшую панель управления "Свойства обозревателя".

- Убедитесь, что у пользователей есть разрешение прокси-сервера на доступ к конечным точкам общего доступа к данным. Для этого варианта требуется, чтобы в устройствах были консольные пользователи с разрешениями прокси, поэтому вы не можете использовать этот метод с устройствами без заголовка.

> [!IMPORTANT]
> Подход проверки подлинности прокси-сервера пользователя несовместим с использованием Advanced Threat Protection в Microsoft Defender. Это поведение обусловлено тем, что для этой проверки подлинности используется раздел реестра **DisableEnterpriseAuthProxy**, для которого установлено значение `0`, а для ATP в Microsoft Defender необходимо, чтобы для раздела было установлено значение `1`. Дополнительные сведения см. в статье [Настройка параметров прокси-сервера компьютера и подключения к Интернету](https://docs.microsoft.com/windows/security/threat-protection/windows-defender-atp/configure-proxy-internet-windows-defender-advanced-threat-protection).

#### <a name="device-proxy-authentication"></a>Проверка подлинности прокси-сервера устройства

Этот подход поддерживает следующие сценарии использования:

- Неподключенные устройства, на которые не входят пользователи, или пользователи устройства не имеют доступа к Интернету

- Прошедшие проверку подлинности прокси-серверы, которые не используют встроенную проверку подлинности Windows

- Использование Advanced Threat Protection в Microsoft Defender

Этот подход самый сложный, так как для него требуются следующие конфигурации:

- Убедитесь, что устройства могут подключаться к прокси-серверу через WinHTTP в контексте локальной системы. Используйте один из следующих параметров для настройки этого поведения:

  - Командная строка `netsh winhttp set proxy`

  - Протокол автоматического обнаружения веб-прокси (WPAD)

  - Прозрачный прокси-сервер.

  - Настройте прокси-сервер WinINET в масштабе устройства, используя следующий параметр групповой политики: **Задать параметры прокси для компьютера (а не для пользователя)** (ProxySettingsPerUser = `1`)

  - Перенаправленное подключение или использующее преобразование сетевых адресов (NAT).

- Настройте прокси-серверы, чтобы предоставить учетным записям компьютеров в Active Directory доступ к конечным точкам данных. Для этой конфигурации требуются прокси-серверы, чтобы обеспечить поддержку встроенной проверки подлинности Windows.  


## <a name="frequently-asked-questions"></a><a name="bkmk_uea_faq"></a> Часто задаваемые вопросы

### <a name="will-my-endpoint-analytics-data-migrate-if-i-move-my-intune-tenant-to-a-different-tenant-location"></a>Будут ли перенесены данные Аналитики конечной точки при перемещении клиента Intune в другое расположение?

При переносе клиента Intune в другое расположение все данные в решении "Аналитика конечной точки" во время миграции будут потеряны. Так как конечные точки передаются в решение "Аналитика конечных точек" непрерывно, все события, происходящие после миграции, автоматически отправляются в новое расположение клиента, и отчеты начинают заполняться повторно при условии правильной регистрации устройств. 

### <a name="why-are-the-scripts-exiting-with-a-code-of-1"></a>Почему сценарии завершаются с кодом 1?

Сценарии завершают работу с кодом 1, чтобы сообщить Intune о том, что должно произойти исправление. В этом случае выход из сценария обнаружения с 1 означает, что требуется исправление. Многие пакеты сценариев, которые запускаются только в CM, могут показывать соответствие, но завершатся с кодом 1. Для этих сценариев завершение с кодом 1 не является чем-то тревожным, однако, возможно вы захотите проверить, прошло ли исправление устройства должным образом.

### <a name="why-did-the-update-stale-group-policies-script-return-with-error-0x87d00321"></a>Почему сценарий "Обновление устаревших групповых политик" возвратил ошибку 0x87D00321?

0x87D00321 — ошибка, обозначающая превышение времени ожидания выполнения сценария. Эта ошибка обычно возникает на компьютерах, подключенных удаленно. Потенциальное устранение рисков заключается только в развертывании в динамической коллекции компьютеров, имеющих внутреннее подключение к сети.

## <a name="script-descriptions"></a><a name="bkmk_uea_scripts"></a> Описание сценариев

В этой таблице показаны имена сценариев, описания, обнаружения, исправления и настраиваемые элементы. Файлы сценариев, имена которых начинаются с `Detect`, являются сценариями обнаружения. Сценарии исправления начинаются с `Remediate`. Эти сценарии можно скопировать из следующего раздела этой статьи.

|Имя сценария|Описание:|
|---|---|
|**Обновление устаревших групповых политик** </br>`Detect_stale_Group_Policies.ps1` </br> `Remediate_stale_GroupPolicies.ps1`| Обнаруживает, что последнее обновление групповой политики происходило больше `7 days` назад.  </br>Настройте пороговое значение на 7 дней, изменив значение для `$numDays` в сценарии обнаружения. </br></br>Выполняет исправление, запуская `gpupdate /target:computer /force` и `gpupdate /target:user /force`  </br> </br>Доставка сертификатов и конфигураций через групповую политику может способствовать уменьшению количества обращений в службу поддержки, связанных с сетевыми подключениями. </br> </br> **Запуск сценария с использованием текущих учетных данных**. Да|
|**Перезапуск службы Office "Нажми и работай"** </br> `Detect_Click_To_Run_Service_State.ps1` </br> `Remediate_Click_To_Run_Service_State.ps1`| Определяет, настроена ли служба "Нажми и работай" на автоматический запуск, или не остановлена ли она. </br> </br> Ошибка устраняется путем настройки службы на автоматический запуск и запуск службы, если она остановлена. </br></br> Помогает устранить проблемы, связанные с невозможностью запуска Приложений Microsoft 365 для предприятия (Win32) из-за остановки службы, используемой для запуска. </br> </br> **Запуск сценария с использованием текущих учетных данных**. Нет|
|**Проверка сетевых сертификатов** </br>`Detect_Expired_Issuer_Certificates.ps1` </br>`Remediate_Expired_Issuer_Certificates.ps1`|Обнаруживает сертификаты, выданные Центром сертификации, в личном хранилище компьютера или пользователя, срок действия которых истек или приближается к истечению. </br> Укажите ЦС, изменив значение для `$strMatch` в сценарии обнаружения. Укажите значение "0" для параметра `$expiringDays`, чтобы найти сертификаты с истекшим сроком действия, или укажите другое число дней для поиска сертификатов, срок действия которых скоро истечет.  </br></br>Устраняет проблему, вызывая всплывающее уведомление для пользователя. </br> Укажите значения `$Title` и `$msgText`, указав заголовок и текст сообщения, которые должны видеть пользователи. </br> </br> Уведомляет пользователей о просроченных сертификатах, которые, возможно, потребуется обновить. </br> </br> **Запуск сценария с использованием текущих учетных данных**. Нет|
|**Очистка устаревших сертификатов** </br>`Detect_Expired_User_Certificates.ps1` </br> `Remediate_Expired_User_Certificates.ps1`| Обнаружение сертификатов с истекшим сроком действия, выданных Центром сертификации, в личном хранилище текущего пользователя. </br> Укажите ЦС, изменив значение для `$certCN` в сценарии обнаружения. </br> </br> Устранение ошибки путем удаления просроченных сертификатов, выданных центром сертификации из личного хранилища текущего пользователя. </br> Укажите ЦС, изменив значение для `$certCN` в сценарии исправления. </br> </br> Находит и удаляет просроченные сертификаты, выданные центром сертификации из личного хранилища текущего пользователя. </br> </br> **Запуск сценария с использованием текущих учетных данных**. Да|

## <a name="powershell-scripts"></a><a name="bkmk_uea_ps_scripts"></a> Сценарии PowerShell

### <a name="detect_stale_group_policiesps1"></a>Detect_stale_Group_Policies.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Detect_stale_Group_Policies.ps1
# Description:     Detect if Group Policy has been updated within number of days
# Notes:           Remediate if "Match", $numDays default value of 7, change as appropriate
#
#=============================================================================================================================

# Define Variables
$numDays = 7

try {
    $gpResult = gpresult /R | Select-String -pattern "Last time Group Policy was applied:" | Select-Object -last 1

    if ($gpResult){
    [int]$lastGPUpdateDays = (New-TimeSpan -Start $lastGPUpdateDate -End (Get-Date)).Days
        if ($lastGPUpdateDays -gt $numDays){
            #We want within last $numDays so we get "Match"
            Write-Host "Match"
            exit 1
        }
        else {
            #Script succeeds but > $numDays since last update so remediate
            #Exit 1 for Intune and "Match" for ConfigMan
            Write-Host "No_Match"
            exit 0
        }
    }
}
catch {
    $errMsg = $_.Exception.Message
    Write-Error $errMsg
    exit 1
}
```

### <a name="remediate_stale_grouppoliciesps1"></a>Remediate_stale_GroupPolicies.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Remediate_stale_GroupPolicies.ps1
# Description:     This script triggers Group Policy update
# Notes:           No variable substitution needed
#
#=============================================================================================================================

try{
    $compGP = gpupdate /target:computer /force | out-string
    $userGP = gpupdate /target:user /force | out-string
    exit 0
}
catch{
    $errMsg = $_.Exception.Message
    Write-Error $errMsg
    exit 1
}
```

### <a name="detect_click_to_run_service_stateps1"></a>Detect_Click_To_Run_Service_State.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Detect_Click_To_Run_Service_State.ps1
# Description:     Detect if Office 16 installed and if "Click to Run Service" is running.
# Notes:           No variable substitution should be necessary
#
#=============================================================================================================================

# Define Variables
$curSvcStat,$svcCTRSvc,$errMsg = "","",""

# Main script
If (-not (Test-Path -Path 'hklm:\Software\Microsoft\Office\16.0')){
    Return "Office 16.0 (or greater) not present on this machine"
    exit 0   
} 

Try{        
    $svcCTRSvc = Get-Service "ClickToRunSvc"
    $curSvcStat = $svcCTRSvc.Status
}

Catch{    
    $errMsg = $_.Exception.Message
    Write-Error $errMsg
    exit 1
}

If ($curSvcStat -eq "Running"){
    Write-Output $curSvcStat
    exit 0                        
}
Else{
    If($curSvcStat -eq "Stopped"){
    Write-Output $curSvcStat
    exit 1     
    }
}
Else{
    Write-Error "Error: " + $errMsg
    exit 1
}
```

### <a name="remediate_click_to_run_service_stateps1"></a>Remediate_Click_To_Run_Service_State.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Remediate_Click_To_Run_Service_State.ps1
# Description:     Start the "Click to Run Service" and change its startup type to Automatic
#       Notes:     No variable substitution needed
#
#=============================================================================================================================

# Define Variables
$svcCur = "ClickToRunSvc"
$curSvcStat,$svcCTRSvc,$errMsg = "","",""
$ctr = 0

# Main script
# Make sure nothing has changed since detection, the service exists and is stopped
Try{        
    $svcCTRSvc = Get-Service "ClickToRunSvc"
    $curSvcStat = $svcCTRSvc.Status
    }

Catch{    
    $errMsg = $_.Exception.Message
    }
        
# If the service got started between detection and now (nested if) then return
# If the service got uninstalled or corrupted between detection and now (else) then return the "Error: " + the error
If ($curSvcStat -ne "Stopped"){
    If ($curSvcStat -eq "Running"){
        return
    }
    Else{
        return "Error: " + $errMsg
    }
}

# Service should be there and stopped, change the startup type and start
Try{        
    Set-Service $svcCur -StartupType Automatic
    Start-Service $svcCur
    $svcCTRSvc = Get-Service $svcCur
    $curSvcStat = $svcCTRSvc.Status
        While ($curSvcStat.Equals("Stopped")){
            Start-Sleep -Seconds 5
            ctr++
            if(ctr == 12){
                Return "Service could not be started after 60 seconds"
                break
            }
        }
    }

Catch{    
    $errMsg = $_.Exception.Message
    Return $errMsg
    }

Return $curSvcStat
```

### <a name="detect_expired_issuer_certificatesps1"></a>Detect_Expired_Issuer_Certificates.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Detect_Expired_Issuer_Certificates.ps1
# Description:     Detect expired certificates issued by "CN=<your CA here>" in either Machine
#                  or User certificate store
# Notes:           Change the value of the variable $strMatch from "CN=<your CA here>" to "CN=..."
#                  For testing purposes the value of the variable $expiringDays can be changed to a positive integer
#                  Don't change the $results variable
#
#=============================================================================================================================

# Define Variables
$results = @()
$expiringDays = 0
$strMatch = "CN=<your CA here>"

try
{
    $results = @(Get-ChildItem -Path Cert:\LocalMachine\My -Recurse -ExpiringInDays $expiringDays | where {$_.Issuer -match $strMatch})
    $results += @(Get-ChildItem -Path Cert:\CurrentUser\My -Recurse -ExpiringInDays $expiringDays | where {$_.Issuer -match $strMatch}) 
    if (($results -ne $null)){
        #Below necessary for Intune as of 10/2019 will only remediate Exit Code 1
        Write-Host "Match"
        Return $results.count
        exit 1
    }
    else{
        #No matching certificates, do not remediate
        Write-Host "No_Match"        
        exit 0
    }   
}
catch{
    $errMsg = $_.Exception.Message
    Write-Error $errMsg
    exit 1
}
```

### <a name="remediate_expired_issuer_certificatesps1"></a>Remediate_Expired_Issuer_Certificates.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Remediate_Expired_Issuer_Certificates.ps1
# Description:     Raise a Toast Notification if expired certificates issued by "CN=..."
#                  to user or machine on the machine where detection script found them. No remediation action besides
#                  the Toast is taken.
# Notes:           Change the values of the variables $Title and $msgText
#
#=============================================================================================================================

## Raise toast to have user contact whoever is specified in the $msgText

# Define Variables
$delExpCert = 0
$Title = "Title"
$msgText = "message"

# Main script
[Windows.UI.Notifications.ToastNotificationManager, Windows.UI.Notifications, ContentType = WindowsRuntime] | Out-Null
[Windows.UI.Notifications.ToastNotification, Windows.UI.Notifications, ContentType = WindowsRuntime] | Out-Null
[Windows.Data.Xml.Dom.XmlDocument, Windows.Data.Xml.Dom.XmlDocument, ContentType = WindowsRuntime] | Out-Null

$APP_ID = '{1AC14E77-02E7-4E5D-B744-2EB1AE5198B7}\WindowsPowerShell\v1.0\powershell.exe'

$template = @"
<toast>
    <visual>
        <binding template="ToastText02">
            <text id="1">$Title</text>
            <text id="2">$msgText</text>
        </binding>
    </visual>
</toast>
"@

$xml = New-Object Windows.Data.Xml.Dom.XmlDocument
$xml.LoadXml($template)
$toast = New-Object Windows.UI.Notifications.ToastNotification $xml
[Windows.UI.Notifications.ToastNotificationManager]::CreateToastNotifier($APP_ID).Show($toast)
```

### <a name="detect_expired_user_certificatesps1"></a>Detect_Expired_User_Certificates.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Detect_Expired_User_Certificates.ps1
# Description:     Detect expired certificates issued by "CN=<your CA here>" to User
# Notes:           Change the value of the variable $certCN from "CN=<your CA here>" to "CN=...".
#                  Don't change $results
#
#=============================================================================================================================

# Define Variables
$results = 0
$certCN = "CN=<your CA here>"

try
{   
    $results = Get-ChildItem -Path Cert:\CurrentUser\My -Recurse -ExpiringInDays 0 | where {$_.Issuer -eq($certCN)}
    if (($results -ne $null)){
        #Below necessary for Intune as of 10/2019 will only remediate Exit Code 1
        Write-Host "Match"
        Return $results.count
        exit 1
    }
    else{
        Write-Host "No_Match"
        exit 0
    }    
}
catch{
    $errMsg = $_.Exception.Message
    Write-Error $errMsg
    exit 1
}
```

### <a name="remediate_expired_user_certificatesps1"></a>Remediate_Expired_User_Certificates.ps1

```powershell
#=============================================================================================================================
#
# Script Name:     Remediate_Expired_User_Certificates.ps1
# Description:     Remove expired certificates issued by "CN=<your CA here>" to User
# Notes:           Change the value of the variable $certCN from "CN=<your CA here>" to "CN=..."
#
#=============================================================================================================================

# Define Variables
$certCN = "CN=<your CA here>"

try
{
    Get-ChildItem -Path cert:\CurrentUser -Recurse -ExpiringInDays 0 | where {$_.Issuer -eq($certCN)} | Remove-Item
    exit 0
}
catch{
    $errMsg = $_.Exception.Message
    Write-Error $errMsg
    exit 1
}
```

## <a name="endpoint-analytics-data-privacy"></a><a name="bkmk_uea_privacy"></a> Конфиденциальность данных в Аналитике конечных точек

### <a name="data-flow"></a>Поток данных

На рисунке ниже показано, как необходимые функциональные данные передаются из отдельных устройств через наши службы данных, временное хранилище к клиенту. Данные проходят через существующие корпоративные конвейеры без необходимости в диагностических данных Windows.

[![Диаграмма потока данных взаимодействия с пользователем](media/dataflow.png)](media/dataflow.png#lightbox)

1. Настройте политику **Сбор данных Intune** для зарегистрированных устройств. По умолчанию при **запуске** Аналитики конечных точек эта политика назначается параметру "Все устройства". Однако можно в любое время [изменить назначения](#bkmk_uea_set) на подмножество устройств или вообще не выбирать устройства.

2. Устройства отправляют необходимые функциональные данные.

    - Для устройств Intune с назначенной политикой данные отправляются из расширения управления Intune. Дополнительные сведения см. в разделе [Требования](#bkmk_uea_prereq).
    - Для устройств, управляемых Configuration Manager, данные также могут передаваться в Microsoft Endpoint Management через соединитель Configuration Manager. Соединитель Configuration Manager подключен к облаку. Ему требуется только подключение к клиенту Intune, а не включение совместного управления.

> [!Note]  
> Данные, необходимые для вычисления оценки запуска для устройства, создаются во время загрузки. В зависимости от параметров электропитания и поведения пользователя для отображения оценки запуска в консоли администрирования может потребоваться несколько недель после того, как устройству правильно назначена политика.  

3. Служба управления конечными точками (Майкрософт) обрабатывает данные для каждого устройства и публикует результаты для отдельных устройств и организационных статистических вычислений в консоли администрирования с помощью API-интерфейсов MS Graph.

Среднее время сквозной задержки составляет около 12 часов и выводится на момент времени, затрачиваемого на ежедневную обработку. Все остальные части потока данных предоставляются почти в режиме реального времени.

### <a name="data-collection"></a><a name="bkmk_uea_datacollection"></a>Сбор данных

В настоящее время базовая функция Аналитики конечных точек собирает сведения, связанные с записями производительности загрузки, которые относятся к категориям [Опознано](https://docs.microsoft.com/mem/intune/protect/privacy-data-collect#identified-data) и [Псевдонимизировано](https://docs.microsoft.com/mem/intune/protect/privacy-data-collect#pseudonymized-data). При добавлении дополнительных функциональных возможностей с течением времени собираемые данные будут меняться по мере необходимости. Основные данные, собираемые в настоящее время

#### <a name="identified-data"></a>Идентифицированные данные

- Данные инвентаризации оборудования
  - **make:** Изготовитель устройства
  - **model:** Модель устройства
  - **deviceClass:** Классификация устройства. Например, "Настольный ПК", "Сервер" или "Мобильное устройство".
  - **Country:** Региональные настройки устройства
- Инвентаризация приложений, например
  - **name:** Windows
  - **ver:** Версия текущей операционной системы.
  
#### <a name="pseudonymized-data"></a>Данные, переведенные в анонимную форму

- Сведения о диагностике, производительности и использовании, связанные с пользователем и (или) устройством
  - **logOnId**
  - **bootId:** Идентификатор загрузки системы
  - **coreBootTimeInMilliseconds:** Время для базовой загрузки
  - **totalBootTimeInMilliseconds:** Общее время загрузки
  - **updateTimeInMilliseconds:** Время завершения обновления ОС
  - **gpLogonDurationInMilliseconds**: Время для обработки групповых политик
  - **desktopShownDurationInMilliseconds:** Время загрузки рабочего стола (explorer.exe)
  - **desktopUsableDurationInMilliseconds:** Время использования рабочего стола (explorer.exe)
  - **topProcesses:** Список процессов, загруженных во время загрузки с именем, статистика загрузки ЦП и сведения о приложении (имя, издатель, версия). Например, *{\"ProcessName\":\"svchost\",\"CpuUsage\":43,\"ProcessFullPath\":\"C:\\\\Windows\\\\System32\\\\svchost.exe\",\"ProductName\":\"Microsoft&reg; Windows&reg; Operating System\",\"Publisher\":\"Microsoft Corporation\",\"ProductVersion\":\"10.0.18362.1\"}*
- Данные на устройстве, не привязанные к устройству или пользователю (если данные привязаны к устройству или пользователю, Intune обрабатывает их как идентифицированные)
  - **ID:** Уникальный идентификатор устройства, используемый Центром обновления Windows
  - **localId:** Локальный уникальный идентификатор устройства. Это имя устройства, которое отличается от его понятного имени. Вероятнее всего, это будет значение, хранящееся в разделе реестра HKLM\Software\Microsoft\SQMClient\MachineId.
  - **aaddeviceid:** Идентификатор устройства Azure Active Directory
  - **orgId:** Уникальный идентификатор GUID, представляющий клиент Microsoft Office 365
  
> [!Important]  
> Наши политики обработки данных описаны в [заявлении о конфиденциальности Microsoft Intune](https://docs.microsoft.com/legal/intune/microsoft-intune-privacy-statement). Мы используем ваши данные клиента только для предоставления служб, для использования которых вы зарегистрированы. Как описано в процессе адаптации, мы анонимизируем и агрегируем рейтинги всех зарегистрированных организаций для обновления базовых показателей.


### <a name="resources"></a>Ресурсы

Дополнительные сведения об аспектах, связанных с обеспечением конфиденциальности, см. в следующих статьях:

- [Microsoft Intune Privacy Statement](https://docs.microsoft.com/legal/intune/microsoft-intune-privacy-statement) (Заявление о конфиденциальности для Microsoft Intune)
- [Windows 10 & Privacy Compliance: A Guide for IT and Compliance Professionals](https://docs.microsoft.com/windows/privacy/windows-10-and-privacy-compliance) (Windows 10 и соответствие требованиям к конфиденциальности: руководство для ИТ-специалистов и ответственных за соблюдение законодательства)
- [Licensing Terms and Documentation](https://www.microsoftvolumelicensing.com/DocumentSearch.aspx?Mode=3&DocumentTypeId=31) (Документация по лицензированию и условия)  
- [Глобальная инфраструктура Azure](https://azure.microsoft.com/global-infrastructure/)  
- [Надежное облако](https://azure.microsoft.com/overview/trusted-cloud/)  
- [Будущее за Trusted Cloud](https://www.microsoft.com/trustcenter)  
