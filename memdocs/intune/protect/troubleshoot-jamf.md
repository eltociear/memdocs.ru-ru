---
title: Устранение неполадок интеграции Jamf Pro с Microsoft Intune
titleSuffix: Microsoft Intune
description: Рекомендации по устранению распространенных проблем с интеграцией Jamf Pro для устройств Mac c Microsoft Intune.
keywords: ''
author: brenduns
ms.author: brenduns
manager: dougeby
ms.date: 04/13/2020
ms.topic: troubleshooting
ms.service: microsoft-intune
ms.subservice: protect
ms.localizationpriority: medium
ms.technology: ''
ms.assetid: ''
ms.reviewer: ''
search.appverid: MET150
ms.custom: intune-azure
ms.collection: M365-identity-device-management
ms.openlocfilehash: 49749ec3a839b11062b1cc2655a1cca4e3d6cfb0
ms.sourcegitcommit: 7f17d6eb9dd41b031a6af4148863d2ffc4f49551
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "81525714"
---
# <a name="troubleshoot-integration-of-jamf-pro-with-microsoft-intune"></a>Устранение неполадок интеграции Jamf Pro с Microsoft Intune

С помощью сведений, приведенных в этой статье, администраторы Intune смогут понять и устранить проблемы, возникающие при интеграции Jamf Pro для macOS с Intune.

> [!TIP]  
> Большая часть информации, приведенной в этой статье, была изначально опубликована в статье [Устранение неполадок интеграции Jamf с Microsoft Intune](https://support.microsoft.com/help/4519171/troubleshoot-problems-when-integrating-jamf-with-microsoft-intune) на сайте support.microsoft.com.

## <a name="prerequisites"></a>Предварительные условия

Перед тем как приступить к устранению неполадок, соберите базовые сведения, чтобы прояснить проблему и сократить время на поиск решения. Например, при возникновении проблем, связанных с интеграцией Jamf с Intune, всегда проверьте, что все предварительные требования выполнены. Прежде чем приступить к устранению неполадок, ознакомьтесь со следующими вопросами.

- Ознакомьтесь с предварительными требованиями, приведенными в следующих статьях, в зависимости от способа настройки интеграции Jamf Pro с Intune:
  - [Использование соединителя Jamf Cloud для интеграции Jamf Pro с Intune](conditional-access-jamf-cloud-connector.md)
  - [Интеграция Jamf Pro с Intune](conditional-access-integrate-jamf.md#prerequisites)
- Все пользователи должны иметь лицензии Premium P1 на Microsoft Intune и Microsoft AAD
- Вам необходимо иметь учетную запись пользователя, у которой есть разрешения на интеграцию с Microsoft Intune в консоли Jamf Pro.
- Вам необходимо иметь учетную запись пользователя, у которой есть разрешения глобального администратора в Azure.

При изучении интеграции Jamf Pro с Intune учитывайте следующие сведения:

- Какое именно сообщение об ошибке отображается?
- Где это происходит?
- Когда появилась проблема?  Удавалось ли ранее настроить интеграцию Jamf Pro с Intune?
- Сколько пользователей затронуто? Все ли пользователи затронуты или лишь некоторые из них?
- Сколько затронуто устройств? Все ли устройства затронуты или лишь некоторые из них?
 
## <a name="common-problems"></a>Распространенные проблемы

Следующие сведения помогут определить и устранить распространенные проблемы с устройствами после настройки интеграции Jamf Pro с Intune.  

| Проблема   | Дополнительные сведения                  |
|-----------------|--------------------------|
| **Устройства помечаются как не отвечающие в Jamf Pro**  | [Не удается синхронизировать устройства с помощью Jamf Pro или Azure AD](#devices-are-marked-as-unresponsive-in-jamf-pro) |
| **Устройства Mac запрашивают вход с цепочкой ключей при приложения; не удается зарегистрировать устройства**  | [У пользователей запрашивается пароль, чтобы разрешить регистрацию приложений в Azure AD](#mac-devices-prompt-for-keychain-sign-in-when-you-open-an-app). |
| **Не удается зарегистрировать устройства**  | Эти проблемы могут быть вызваны следующими причинами. <br> **-** [***Причина 1*** — неверные разрешения у приложения Jamf Pro в Azure](#cause-1) <br> **-** [***Причина 2*** — проблема с приложением *Jamf Native macOS Connector* в Azure AD](#cause-2) <br> **-** [***Причина 3*** — у пользователя нет действительной лицензии Intune или Jamf](#cause-3) <br> **-** [***Причина 4*** — пользователь не использовал службу самообслуживания Jamf для запуска приложения корпоративного портала](#cause-4) <br> **-** [***Причина 5*** — интеграция с Intune отключена](#cause-5) <br> **-** [***Причина 6*** — устройство было ранее зарегистрировано в Intune или пользователь попытался зарегистрировать устройство несколько раз](#cause-6) <br> **-** [***Причина 7*** — JamfAAD запрашивает доступ к ключу присоединения к рабочей области Microsoft из цепочки ключей пользователей](#cause-7) |
|  **Устройство Mac соответствует требованиям Intune, но не соответствует требованиям Azure** | [Проблемы с регистрацией устройства](#mac-device-shows-compliant-in-intune-but-noncompliant-in-azure) |
| **В консоли Intune для устройств Mac, зарегистрированных с помощью Jamf, отображаются дублирующиеся записи** | [Несколько регистраций с одного и того же устройства](#duplicate-entries-appear-in-the-intune-console-for-mac-devices-enrolled-by-using-jamf) |
| **Политике соответствия не удается оценить устройство** | [Политика нацелена на группы устройств](#compliance-policy-fails-to-evaluate-the-device) |
| **Не удалось получить маркер доступа для API Microsoft Graph** | Эти проблемы могут быть вызваны следующими причинами. <br> -[Разрешения для приложения Jamf Pro в Azure](#theres-a-permission-issue-with-the-jamf-pro-application-in-azure) <br> - [Истек срок действия лицензии для Jamf или Intune](#a-license-required-for-jamf-intune-integration-has-expired) <br> **-** [Не открыты необходимые порты](#the-required-ports-arent-open-on-your-network)|
 

### <a name="devices-are-marked-as-unresponsive-in-jamf-pro"></a>Устройства помечаются как не отвечающие в Jamf Pro  

**Причина**. Ниже приведены распространенные причины, по которым Jamf Pro помечает устройство как *Не отвечающее*:

- Устройство не может выполнить синхронизацию с Jamf Pro.  
  Jamf Pro ожидает, что устройства будут выполнять синхронизацию каждые 15 минут. Если устройство не может выполнить синхронизацию в течение 24 часов, Jamf Pro помечает устройство как не отвечающее.  

- Устройство не может выполнить синхронизацию с Azure AD.  
  После успешной регистрации в Azure AD устройства macOS получают токен Azure:
  - Этот токен обновляется каждые 12 часов.   
  - Если токен не удается обновить в течение 24 часов или более, Jamf Pro помечает устройство как не отвечающее.  
  - Если срок действия токена Azure истечет, пользователям будет предложено войти в Azure для получения нового токен. Токен обновления для доступа к Azure создается каждые семь дней.

**Решение**  
После того как Jamf Pro помечает устройство как *Не отвечающее*, зарегистрированный пользователь устройства должен войти в систему, чтобы устранить это состояние устройства. Это должен быть пользователь, учетная запись которого присоединена к рабочей области, так как в этом случае в цепочке ключей входа будет находиться удостоверение от Intune.



### <a name="mac-devices-prompt-for-keychain-sign-in-when-you-open-an-app"></a>Устройства Mac запрашивают вход с цепочкой ключей при приложения  

После настройки интеграции Intune и Jamf Pro и развертывания политик условного доступа пользователи устройств, управляемых с помощью Jamf Pro, получают запрос на ввод пароля при открытии приложений Microsoft Office 365, таких как Teams, Outlook и других приложений, для которых требуется проверка подлинности Azure AD. 

Например, при открытии Microsoft Teams появляется запрос с текстом, аналогичным приведенному ниже:

``` 
  Microsoft Teams wants to sign using key "Microsoft Workplace Join Key" in your keychain.  
  To allow this, enter the "login" keychain password 
```

**Причина**. Эти запросы создаются Jamf Pro для каждого приложения, для которого требуется регистрация Azure AD. 

**Решение**   
При появлении запроса пользователь должен указать пароль устройства для входа в Azure AD. Возможны следующие значения.
- **Отклонить** — не выполнять вход и не использовать приложение.
- **Разрешить** — выполнить вход один раз. При следующем открытии приложения снова появится запрос на вход.
- **Разрешать всегда** — учетные данные для входа кэшируются для приложения. При следующем открытии приложения запрос на вход не появляется.  

При выборе варианта *Разрешать всегда* для одного приложения будущие операции входа подтверждаются только для этого приложения. Другие приложения будут по-прежнему запрашивать проверку подлинности, если для них также не был установлен вариант *Разрешать всегда*. Кэшированные учетные данные одного приложения не могут использоваться другим приложением.  

### <a name="devices-fail-to-register"></a>Не удается зарегистрировать устройства  

Существует несколько распространенных причин, по которым не удается зарегистрировать устройства Mac.  

#### <a name="cause-1"></a>Причина 1  

**Корпоративное приложение Jamf Pro в Azure имеет неправильные разрешения или имеет несколько разрешений**

  При создании приложения в Azure необходимо удалить все разрешения API по умолчанию, а затем назначить Intune одно разрешение *update_device_attributes*. 

  **Решение**  
  Проверьте и при необходимости исправьте разрешения для приложения Jamf. При использовании облачного соединителя Jamf Pro это приложение создается автоматически. Если интеграция была настроена вручную, вы создали это приложение в Azure AD. Сведения о разрешениях для приложения см. в описании процедуры [создания приложения для Jamf в Azure AD](conditional-access-integrate-jamf.md#create-an-application-in-azure-active-directory).

#### <a name="cause-2"></a>Причина 2  

**В вашем клиенте Azure AD не создано приложение **Jamf Native macOS Connector** или согласие для этого соединителя было подписано учетной записью, не имеющей прав глобального администратора**  

  **Решение**  
  См. раздел *Настройка интеграции macOS с Intune* в разделе [Интеграция с Microsoft Intune](https://docs.jamf.com/10.13.0/jamf-pro/administrator-guide/Integrating_with_Microsoft_Intune.html) на сайте docs.jamf.com.

#### <a name="cause-3"></a>Причина 3

**У пользователя нет действительной лицензии Intune или Jamf**

  Отсутствие действительной лицензии может привести к следующей ошибке, которая означает, что срок действия лицензии Jamf истек:  
  ```
    Unable to connect to Microsoft Intune.  
    
    Check your Microsoft Intune Integration configuration.
  ```  

  **Решение**
  - Лицензия Jamf: обратитесь в Jamf, чтобы получить помощь по получению новой лицензии для Jamf.  
  - Лицензия Intune: назначьте пользователю действительную лицензию или обратитесь в корпорацию Майкрософт или к своему партнеру за информацией о том, как получить действительную лицензию.

#### <a name="cause-4"></a>Причина 4  

**Пользователь не использовал *службу самообслуживания Jamf* для запуска приложения корпоративного портала**

Чтобы успешно зарегистрировать устройство в Intune через Jamf, пользователь должен использовать службу самообслуживания для открытия корпоративного портала Intune. Если пользователь откроет корпоративный портал вручную, устройство будет зарегистрировано без подключения к Jamf.  

Чтобы определить, какую службу устройство использовало для регистрации, просмотрите приложение корпоративного портала на устройстве. При регистрации через Jamf вы получите уведомление о том, что необходимо открыть приложение самообслуживания для внесения изменений.

В приложении корпоративного портала пользователь может увидеть **`Not registered`** , а в журналах корпоративного портала может появиться запись, похожая на следующий пример:  

```
   Line 7783: <DATE> <IP ADDRESS> INFO com.microsoft.ssp.application TID=1  
 
   WelcomeViewController.swift: 253 (startLogin()) Portal launched without WPJ only arg while account is under partner management
```

**Решение**  
Чтобы изменить источник регистрации с Intune на Jamf, сделайте следующее.
1. [Отмените регистрацию устройства с macOS в Intune](https://docs.microsoft.com/mem/intune/user-help/unenroll-your-device-from-intune-macos). Чтобы избежать дополнительных осложнений для устройств, которые не были полностью удалены из Intune, см. раздел [*Причина 6*](#cause-6) в этом списке причин.  

2. На устройстве откройте приложение корпоративного портала с помощью службы самообслуживания, а затем зарегистрируйте устройство в Intune. Для этой задачи необходимо [разворачивать приложение корпоративного портала для macOS с помощью Jamf](conditional-access-assign-jamf.md#deploy-the-company-portal-app-for-macos-in-jamf-pro), а также [создать политику в Jamf Pro, которая регистрирует устройства пользователей в Azure AD](conditional-access-assign-jamf.md#create-a-policy-in-jamf-pro-to-have-users-register-their-devices-with-azure-active-directory).  

3. При открытии портала отображается экран с запросом на вход. Использование рабочей или учебной учетной записи  

4. Корпоративный портал проверяет сведения об учетной записи, а затем показывает сведения о состояниях регистрации устройства и соответствия устройства. Желтыми треугольниками выделены действия, которые необходимо выполнить для защиты служебного устройства с macOS. Нажмите кнопку "Начать", чтобы начать регистрацию.  

5. При появлении соответствующего запроса введите сведения для входа с вашего компьютера.  
     
Регистрация устройства в службе управления может занять несколько минут. В течение этого времени вы можете выполнять на устройстве другие действия. После завершения настройки доступа к ресурсам организации появится соответствующее сообщение.

#### <a name="cause-5"></a>Причина 5  

**Интеграция с Intune отключена**

Если интеграция с Intune отключена, при попытке регистрации устройства на корпоративном портале появляется всплывающее окно со следующим сообщением:  

```
   Invalid command line input
   
   Registration-only command line flag (-r) can only be used when partner management is enabled in Intune. Please contact your IT admin.
```  

Сервер Jamf Pro отправляет сигнал проверки связи на серверы Intune, когда интеграция отключена. Так Intune определяет, что интеграция отключена. 

**Решение**  
Повторно включите интеграцию с Intune в Jamf Pro. См. следующие сведения в зависимости от способа настройки интеграции.

- [Использование соединителя Jamf Cloud для интеграции Jamf Pro с Intune](conditional-access-jamf-cloud-connector.md)
- [Настройка интеграции Microsoft Intune в Jamf Pro вручную](conditional-access-integrate-jamf.md#enable-intune-to-integrate-with-jamf-pro)

#### <a name="cause-6"></a><a name="cause-6"></a>Причина 6  

**Устройство было ранее зарегистрировано в Intune или пользователь попытался зарегистрировать устройство несколько раз**

Если регистрация устройства в Jamf была успешно удалена, но устройство не было должным образом удалено из Intune, или если выполняется несколько попыток регистрации, то на портале может появиться несколько экземпляров одного и того же устройства. Это приводит к сбою при регистрации Jamf.

**Решение**  
1. На компьютере Mac запустите **Терминал**.
2. Выполните команду **sudo JAMF removemdmprofile**.
3. Выполните команду **sudo JAMF removeFramework**.
4. На сервере JAMF Pro удалите запись инвентаризации компьютера.
5. Удалите устройство из AzureAD.
6. Удалите следующие файлы на устройстве, если они существуют:
   - /Library/Application Support/com.microsoft.CompanyPortal.usercontext.info
   - /Library/Application Support/com.microsoft.CompanyPortal
   - /Library/Application Support/com.jamfsoftware.selfservice.mac
   - /Library/Saved Application
   - State/com.jamfsoftware.selfservice.mac.savedState
   - /Library/Saved Application State/com.microsoft.CompanyPortal.savedState
   - /Library/Preferences/com.microsoft.CompanyPortal.plist
   - /Library/Preferences/com.jamfsoftware.selfservice.mac.plist
   - /Library/Preferences/com.jamfsoftware.management.jamfAAD.plist
   - /Users/<username>/Library/Cookies/com.microsoft.CompanyPortal.binarycookies
   - /Users/<username>/Library/Cookies/com.jamf.management.jamfAAD.binarycookies
   - com.microsoft.CompanyPortal
   - com.microsoft.CompanyPortal.HockeySDK
   - enterpriseregistration.windows.net
   - https://device.login.microsoftonline.com
   - https://device.login.microsoftonline.com/
   - Ключ транспорта сеанса Microsoft (открытый и закрытый ключи)
   - Ключ для присоединения к рабочей области Microsoft (открытый и закрытый ключи)
7. Удалите все данные из цепочки ключей на устройстве, которые ссылаются на *Microsoft*, *Intune* или *корпоративный портал*, включая сертификаты DeviceLogin.microsoft.com. Удалите ссылки на *JAMF*, за исключением открытого и закрытого ключей JAMF. 
   > [!IMPORTANT]  
   > Удаление открытого и закрытого ключей приведет к прерыванию регистрации устройства.

8. Удалите все записи, соответствующие следующим критериям:  
   - Тип: Пароль приложения; Учетная запись: com.microsoft.workplacejoin.thumbprint
   - Тип: Пароль приложения; Учетная запись: com.microsoft.workplacejoin.registeredUserPrincipalName
   - Тип: Сертификат; Выдан: MS-Organization-Access
   - Тип: Параметр удостоверения; имя (URL-адрес службы токенов безопасности ADFS, если имеется): https://adfs\<DNSName>.com/adfs/ls
   - Тип: Параметр удостоверения; имя: `https://enterpriseregistration.windows.net`
   - Тип: Параметр удостоверения; имя: `https://enterpriseregistration.windows.net/`
9. Перезапустите устройство Mac.
10. Удалите корпоративный портал с устройства.
11. Перейдите на страницу portal.manage.microsoft.com и удалите все экземпляры устройства Mac. Подождите по крайней мере 30 минут, прежде чем перейти к следующему шагу.
12. Повторно зарегистрируйте устройство в JAMF Pro.
13. Повторно откройте службу самообслуживания и запустите политику регистрации.


#### <a name="cause-7"></a>Причина 7  

**JamfAAD запрашивает доступ к ключу присоединения к рабочей области Microsoft из цепочки ключей пользователей**

Во время регистрации пользователь устройства macOS получает следующее приглашение, чтобы разрешить JamfAAD доступ к ключу из цепочки ключей: 

```
   JamfAAD wants to access key "Microsoft Workplace Join Key" in your keychain. 
    
   To allow this, enter the "login" keychain password
```

**Решение**  
Для успешной регистрации устройства в Azure AD пользователь должен указать пароль учетной записи и выбрать **Разрешить**.

Этот запрос аналогичен запросу для проблемы [Устройства Mac запрашивают вход с цепочкой ключей при приложения; не удается зарегистрировать устройства](#mac-devices-prompt-for-keychain-sign-in-when-you-open-an-app) ранее в этой статье.  

 
### <a name="mac-device-shows-compliant-in-intune-but-noncompliant-in-azure"></a>Устройство Mac соответствует требованиям Intune, но не соответствует требованиям Azure  

**Причина**. Следующие условия могут привести к тому, что устройство будет отображаться как соответствующее требованиям в Intune, но не будет соответствовать требованиям в Azure:  
- Устройство неправильно зарегистрировано.  
- Устройство было зарегистрировано несколько раз без необходимой очистки.

**Решение**  
Чтобы устранить эту проблему, см. решение для [*причины 6*](#cause-6) проблемы *Не удается зарегистрировать устройства* выше в этой статье. 


### <a name="duplicate-entries-appear-in-the-intune-console-for-mac-devices-enrolled-by-using-jamf"></a>В консоли Intune для устройств Mac, зарегистрированных с помощью Jamf, отображаются дублирующиеся записи  
 
**Причина**. Устройство зарегистрировано в Intune несколько раз, как правило, зарегистрировано повторно после удаления из Intune.  

Когда устройство удаляется из интеграции Jamf Pro с Intune, некоторые данные могут быть сохранены, что может привести к появлению последовательных регистраций и созданию повторяющихся записей.  

**Решение**  
Чтобы устранить эту проблему, см. решение для [*причины 6*](#cause-6) проблемы *Не удается зарегистрировать устройства* выше в этой статье.

### <a name="compliance-policy-fails-to-evaluate-the-device"></a>Политике соответствия не удается оценить устройство  

**Причина**. Интеграция Jamf с Intune не поддерживает политику соответствия требованиям, ориентированную на группы устройств.

**Решение**  
Измените политику соответствия для устройств macOS, чтобы они назначались группам пользователей.

### <a name="could-not-retrieve-the-access-token-for-microsoft-graph-api"></a>Не удалось получить маркер доступа для API Microsoft Graph

Вы получили следующую ошибку:

`Could not retrieve the access token for Microsoft Graph API. Check the configuration for Microsoft Intune Integration.`

Эта ошибка может быть вызвана одной из следующих причин:

#### <a name="theres-a-permission-issue-with-the-jamf-pro-application-in-azure"></a>У приложения Jamf Pro в Azure есть проблема с разрешениями

При регистрации приложения Jamf Pro в Azure возникло одно из следующих условий:

- Приложение получило более одного разрешения.
- Не был выбран параметр **Предоставить согласие администратора для *\<ваша организация>*** .  

**Решение**  
См. решение для причины 1 проблемы [Не удается зарегистрировать устройства](#devices-fail-to-register) выше в этой статье.

#### <a name="a-license-required-for-jamf-intune-integration-has-expired"></a>Срок действия лицензии, необходимой для интеграции Jamf-Intune, истек

**Решение**. См. решение для причины 3 проблемы [Не удается зарегистрировать устройства](#devices-fail-to-register).

#### <a name="the-required-ports-arent-open-on-your-network"></a>В вашей сети не открыты требуемые порты

**Решение**.  
Просмотрите сведения о сетевых портах в разделе [Предварительные требования](conditional-access-jamf-cloud-connector.md#prerequisites) для интеграции Jamf Pro с Intune.

## <a name="next-steps"></a>Дальнейшие шаги

Ознакомьтесь с дополнительными сведениями об [интеграции Jamf Pro с Intune](conditional-access-integrate-jamf.md)