---
title: API для встроенных сторонних центров сертификации
titleSuffix: Microsoft Intune
description: Добавьте или интегрируйте решение GitHub SCEP для сторонних центров сертификации (ЦС) для выдачи сертификатов SCEP для устройств в Microsoft Intune. Это решение включает API Java и C#, которые выполняют проверку, отправляют уведомления об успехе и неудаче в Intune и используют фабрику сокетов SSL при взаимодействии с Intune. Кроме того, мы рекомендуем ознакомиться с обзором процедуры по тестированию конфигурации ЦС SCEP.
keywords: ''
author: Brenduns
ms.author: brenduns
manager: dougeby
ms.date: 12/06/2018
ms.topic: reference
ms.service: microsoft-intune
ms.subservice: protect
ms.localizationpriority: medium
ms.technology: ''
ms.reviewer: ''
ms.suite: ems
search.appverid: MET150
ms.custom: seodec18
ms.collection: M365-identity-device-management
ms.openlocfilehash: 9a915ffc908c985b38533a362f2a17ec561ddf6f
ms.sourcegitcommit: 7f17d6eb9dd41b031a6af4148863d2ffc4f49551
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/21/2020
ms.locfileid: "79351244"
---
# <a name="use-apis-to-add-third-party-cas-for-scep-to-intune"></a>Использование API для добавления сторонних ЦС для SCEP в Intune

В Microsoft Intune можно добавить сторонние центры сертификации (ЦС) и использовать эти ЦС для выдачи и проверки сертификатов с помощью протокола SCEP. В разделе [Добавление стороннего центра сертификации](certificate-authority-add-scep-overview.md) представлен обзор этой функции и описание задач администратора в Intune.

Кроме того, есть несколько задач разработчиков, основанных на библиотеке с открытым исходным кодом, которую корпорация Майкрософт опубликовала на сайте GitHub.com. Библиотека включает API, который:

- проверяет пароль SCEP, динамически создаваемый Intune;
- уведомляет Intune о сертификатах, созданных на устройствах, отправляющих запросы SCEP.

Используя этот API, сторонний сервер SCEP интегрируется с решением для управления SCEP в Intune для устройств MDM. Библиотека абстрагирует такие аспекты, как проверка подлинности, расположение и API службы Intune ODATA от пользователей.

## <a name="scep-management-solution"></a>Решение по управлению SCEP

![Интеграция SCEP стороннего центра сертификации с Microsoft Intune](./media/scep-libraries-apis/scep-certificate-vendor-integration.png)

С помощью Intune администраторы создают профили SCEP, а затем назначают их устройствам MDM. Профили SCEP включают параметры, такие как:

- URL-адрес сервера SCEP;
- доверенный корневой сертификат центра сертификации;
- атрибуты сертификата и многое другое.

Для устройств, регистрирующихся в Intune, назначается профиль SCEP, а также настраиваются эти параметры. Intune динамически создает пароль запроса SCEP, а затем назначает его устройству.

Этот запрос содержит:

- динамически создаваемый пароль запроса;
- сведения о параметрах, ожидаемых в запросе подписи сертификата (CSR), который устройство отправляет на сервер SCEP;
- время окончания срока действия запроса.

Intune шифрует сведения, подписывает зашифрованный большой двоичный объект, а затем упаковывает эти сведения в пароль запроса SCEP.

Устройства, обращающиеся к серверу SCEP для запроса сертификата, предоставляют этот пароль запроса SCEP. Сервер SCEP отправляет CSR и зашифрованный пароль запроса SCEP в Intune для проверки.  Пароль запроса и CSR должны успешно пройти проверку, чтобы сервер SCEP отправил сертификат на устройство. При проверке запроса SCEP выполняются следующие проверки:


- проверка подписи из зашифрованного большого двоичного объекта;
- проверка срока действия запроса защиты;
- проверка того, что профиль по-прежнему назначен устройству;
- проверка соответствия свойств сертификата, запрашиваемого устройством в запросе подписи, ожидаемым значениям.

Решение по управлению SCEP также включает функцию создания отчетов. Администратор может получить сведения о состоянии развертывания профиля SCEP и о сертификатах, выпущенных для устройства.

## <a name="integrate-with-intune"></a>Интеграция с Intune

Код для интеграции библиотеки с SCEP в Intune доступен для загрузки в [репозитории GitHub Microsoft/Intune-Resource-Access](https://github.com/Microsoft/Intune-Resource-Access/tree/develop/src/CsrValidation).

Интеграция библиотеки в ваши продукты включает следующие этапы. Эти инструкции предполагают знание принципов работы с репозиториями GitHub и создания проектов и решений в Visual Studio.

1. Зарегистрируйтесь, чтобы получать уведомления из репозитория.
2. Клонируйте или скачайте репозиторий.
3. Перейдите к нужной реализации библиотеки в папке `\src\CsrValidation` (https://github.com/Microsoft/Intune-Resource-Access/tree/develop/src/CsrValidation).
4. Выполните сборку библиотеки с помощью инструкций в файле сведений.
5. Включение библиотеки в проект, который создает сервер SCEP
6. Выполните следующие задачи на сервере SCEP.

    - Разрешите администратору настраивать [идентификатор приложения Azure, ключ приложения Azure и идентификатор клиента](#onboard-scep-server-in-azure) (в этой статье), используемые библиотекой для проверки подлинности. Администратор должен иметь право изменять ключ приложения Azure.
    - Определите запросы SCEP, которые включают пароль SCEP, созданный Intune.
    - Используйте библиотеку **проверки запросов API** для проверки паролей SCEP, созданных Intune.
    - Используйте API уведомлений библиотеки для уведомления Intune о сертификатах, выпущенных для запросов SCEP, которым назначен созданный Intune пароль SCEP. Кроме того, Intune необходимо уведомлять об ошибках, которые могут возникать при обработке этих запросов SCEP.
    - Убедитесь, что в журналах сервера достаточно информации для устранения неполадок администраторами.

7. Выполните [тестирование интеграции](#integration-testing) (в этой статье) и устраните все проблемы.
8. Разработайте письменные инструкции для клиента, объясняющие:

    - порядок подключения сервера SCEP на портале Azure;
    - порядок получения идентификатора приложения Azure и ключа приложения Azure, необходимых для настройки библиотеки.

### <a name="onboard-scep-server-in-azure"></a>Подключение сервера SCEP в Azure

Для проверки подлинности в Intune серверу SCEP требуется идентификатор приложения Azure, ключ приложения Azure и идентификатор клиента. Серверу SCEP также требуется разрешение на доступ к API Intune.

Чтобы получить эти данные, администратор сервера SCEP выполняет вход на портал Azure, регистрирует приложение, предоставляет приложению разрешение на **проверку запроса защиты API\SCEP Microsoft Intune**, создает ключ для приложения, а затем скачивает идентификатор приложения, его ключ и идентификатор клиента.

Инструкции по регистрации приложения и получению идентификаторов и ключей см. в разделе [Создание приложения Azure Active Directory и субъекта-службы с доступом к ресурсам с помощью портала](https://docs.microsoft.com/azure/azure-resource-manager/resource-group-create-service-principal-portal).

### <a name="java-library-api"></a>API библиотеки Java

Библиотека Java реализуется как проект Maven, опрашивающий свои зависимости при сборке. API реализуется в пространстве имен `com.microsoft.intune.scepvalidation` класса `IntuneScepServiceClient`.

#### <a name="intunescepserviceclient-class"></a>Класс IntuneScepServiceClient

Класс `IntuneScepServiceClient` включает методы, используемые службой SCEP, для проверки паролей SCEP, для уведомления Intune о созданных сертификатах и создания списка ошибок.

##### <a name="intunescepserviceclient-constructor"></a>Конструктор IntuneScepServiceClient

Сигнатура:

```java
IntuneScepServiceClient(
    Properties configProperties)
```

Описание:

Создает и настраивает объект `IntuneScepServiceClient`.

Параметры:

    - configProperties — объект свойств, содержащий сведения о конфигурации клиента

Конфигурация должна включать следующие свойства:

    - AAD_APP_ID="Идентификатор приложения Azure, полученный при подключении"
    - AAD_APP_KEY="Ключ приложения Azure, полученный при подключении"
    - TENANT="Идентификатор клиента, полученный во время подключения"
    - PROVIDER_NAME_AND_VERSION="Сведения для идентификации продукта и его версии"
    
Если решению требуется прокси-сервер с проверкой подлинности или без нее, можно добавить следующие свойства.

    - PROXY_HOST = "Узел, на котором размещен прокси-сервер"
    - PROXY_PORT = "Порт, прослушиваемый прокси-сервером"
    - PROXY_USER = "Имя пользователя, используемое в случае обычной проверки подлинности на прокси-сервере"
    - PROXY_PASS="Пароль, используемый в случае обычной проверки подлинности на прокси-сервере"

Создает исключение:

    - IllegalArgumentException — создается, если конструктор выполняется без соответствующего объекта свойств.

> [!IMPORTANT]
> Рекомендуется создать экземпляр этого класса и использовать его для обработки нескольких запросов SCEP. Это позволяет сократить временные затраты, так как выполняется кэширование маркеров проверки подлинности и сведений о расположении службы.

**Примечания о безопасности**  
Средство реализации сервера SCEP должно защищать данные, вводимые в свойствах конфигурации, которые сохраняются в хранилище, от изменения и раскрытия. Для защиты данных рекомендуется использовать соответствующие списки управления доступом и шифрование.

##### <a name="validaterequest-method"></a>Метод ValidateRequest

Сигнатура:

```java
void ValidateRequest(
    String transactionId,
    String certificateRequest)
```

Описание:

Проверяет запросы на сертификаты SCEP.

Параметры:

    - transactionId — идентификатор транзакции SCEP
    - certificateRequest — запрос на сертификат PKCS 10 в кодировке DER, закодированный Base64 как строка

Создает исключение:

    - IllegalArgumentException — создается, если вызывается с недопустимым параметром
    - IntuneScepServiceException — создается, если обнаруживается, что запрос на сертификат недопустим
    - Exception — создается, если произошла непредвиденная ошибка

> [!IMPORTANT]
> Исключения, создаваемые этим методом, должны регистрироваться в журнале сервера. Обратите внимание, что свойства `IntuneScepServiceException` включают подробные сведения о причинах сбоя проверки запроса сертификата.

**Примечания о безопасности**  

- Если этот метод вызывает исключение, сервер SCEP **не должен** выдавать сертификат клиенту.
- Сбои при выполнении проверки запроса на сертификат SCEP могут указывать на проблему в инфраструктуре Intune. Кроме того, они могут указывать на попытку злоумышленника получить сертификат.

##### <a name="sendsuccessnotification-method"></a>Метод SendSuccessNotification

Сигнатура:

```java
void SendSuccessNotification(
    String transactionId,
    String certificateRequest,
    String certThumbprint,
    String certSerialNumber,
    String certExpirationDate,
    String certIssuingAuthority)
```

Описание:

Уведомляет Intune о том, что сертификат создается в ходе обработки запроса SCEP.

Параметры:

    - transactionId — идентификатор транзакции SCEP
    - certificateRequest — запрос на сертификат PKCS 10 в кодировке DER, закодированный Base64 как строка
    - certThumprint — хэш SHA1 отпечатка подготовленного сертификата
    - certSerialNumber — серийный номер подготовленного сертификата
    - certExpirationDate — дата окончания срока действия подготовленного сертификата Строка даты и времени должна иметь формат веб-строки времени UTC (YYYY-MM-DDThh:mm:ss.sssTZD) по ISO 8601.
    - certIssuingAuthority — имя центра сертификации, выдавшего сертификат

Создает исключение:

    - IllegalArgumentException — создается, если вызывается с недопустимым параметром
    - IntuneScepServiceException — создается, если обнаруживается, что запрос на сертификат недопустим
    - Exception — создается, если произошла непредвиденная ошибка

> [!IMPORTANT]
> Исключения, создаваемые этим методом, должны регистрироваться в журнале сервера. Обратите внимание, что свойства `IntuneScepServiceException` включают подробные сведения о причинах сбоя проверки запроса сертификата.

**Примечания о безопасности**

- Если этот метод вызывает исключение, сервер SCEP **не должен** выдавать сертификат клиенту.
- Сбои при выполнении проверки запроса на сертификат SCEP могут указывать на проблему в инфраструктуре Intune. Кроме того, они могут указывать на попытку злоумышленника получить сертификат.

##### <a name="sendfailurenotification-method"></a>Метод SendFailureNotification

Сигнатура:

```java
void SendFailureNotification(
    String transactionId,
    String certificateRequest,
    long  hResult,
    String errorDescription)
```

Описание:

Уведомляет Intune о том, что при обработке запроса SCEP произошла ошибка. Этот метод не должен вызываться для исключений, создаваемых методами этого класса.

Параметры:

    - transactionId — идентификатор транзакции SCEP
    - certificateRequest — запрос на сертификат PKCS 10 в кодировке DER, закодированный Base64 как строка
    - hResult — код ошибки Win32, наиболее точно описывающий возникшую ошибку См. раздел [Коды ошибок Win32](https://msdn.microsoft.com/library/cc231199.aspx).
    - errorDescription — описание возникшей ошибки

Создает исключение:

    - IllegalArgumentException — создается, если вызывается с недопустимым параметром
    - IntuneScepServiceException — создается, если обнаруживается, что запрос на сертификат недопустим
    - Exception — создается, если произошла непредвиденная ошибка

> [!IMPORTANT]
> Исключения, создаваемые этим методом, должны регистрироваться в журнале сервера. Обратите внимание, что свойства `IntuneScepServiceException` включают подробные сведения о причинах сбоя проверки запроса сертификата.

**Примечания о безопасности**

- Если этот метод вызывает исключение, сервер SCEP **не должен** выдавать сертификат клиенту.
- Сбои при выполнении проверки запроса на сертификат SCEP могут указывать на проблему в инфраструктуре Intune. Кроме того, они могут указывать на попытку злоумышленника получить сертификат.

##### <a name="setsslsocketfactory-method"></a>Метод SetSslSocketFactory

Сигнатура:

```java
void SetSslSocketFactory(
    SSLSocketFactory factory)
```

Описание:

Этот метод позволяет сообщить клиенту, что он должен использовать указанную фабрику сокетов SSL (вместо используемой по умолчанию) при взаимодействии с Intune.

Параметры:

    - factory — фабрика сокетов SSL, которую клиент должен использовать для HTTPS-запросов

Создает исключение:

    - IllegalArgumentException — создается, если вызывается с недопустимым параметром

> [!NOTE]
> Если требуется фабрика сокетов SSL, она должна быть задана перед выполнением других методов этого класса.

## <a name="integration-testing"></a>Тестирование интеграции

Проверка и тестирование правильной интеграции решения с Intune обязательны. В списке ниже перечислены необходимые этапы.

1. Настройка [пробной учетной записи Intune](../fundamentals/account-sign-up.md).
2. Подключение [сервера SCEP на портале Azure](#onboard-scep-server-in-azure) (в этой статье).
3. [Настройка сервера SCEP](certificates-scep-configure.md) с помощью идентификаторов и ключа, созданных при подключении сервера SCEP.
4. [Регистрация устройств](../enrollment/device-enrollment.md) для проверки сценариев в [матрице тестирования сценариев](https://github.com/Microsoft/Intune-Resource-Access/blob/develop/src/CsrValidation/doc/TestMatrix.csv).
5. [Создание профиля доверенного корневого сертификата](certificates-scep-configure.md) для тестирования вашего ЦС.
6. Создание профилей SCEP для проверки сценариев, перечисленных в [матрице тестирования сценариев](https://github.com/Microsoft/Intune-Resource-Access/blob/develop/src/CsrValidation/doc/TestMatrix.csv).
7. [Назначение профилей](../configuration/device-profile-assign.md) пользователям, которые зарегистрировали свои устройства.
8. Дождитесь завершения синхронизации устройств с Intune. [Устройства также можно синхронизировать](../remote-actions/device-sync.md) вручную.
9. Убедитесь, что доверенный корневой сертификат и [профили SCEP развернуты на устройствах](../configuration/device-profile-monitor.md).
10. Убедитесь, что доверенный корневой сертификат установлен на всех устройствах.
11. Убедитесь, что сертификаты SCEP для назначенных профилей установлены на всех устройствах.
12. Убедитесь, что свойства установленных сертификатов соответствуют свойствам, заданным в профиле SCEP.
13. Убедитесь, что выданные сертификаты правильно указаны в консоли Intune.

## <a name="see-also"></a>См. также

- [Обзор добавления сторонних ЦС](certificate-authority-add-scep-overview.md)
- [Настройка Intune](../fundamentals/setup-steps.md)
- [Регистрация устройств](../enrollment/device-enrollment.md)
- [Настройка профилей сертификатов SCEP](certificates-profile-scep.md) (настройка соединителя или сервера Microsoft NDES не используется для этого сценария)
