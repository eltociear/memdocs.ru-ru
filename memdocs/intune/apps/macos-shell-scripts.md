---
title: Использование скриптов оболочки на устройствах macOS в Microsoft Intune | Документация Майкрософт
description: Создавайте, назначайте, отслеживайте и исправляйте скрипты оболочки для устройств macOS в Microsoft Intune.
keywords: ''
author: Erikre
ms.author: erikre
manager: dougeby
ms.date: 04/30/2020
ms.topic: how-to
ms.service: microsoft-intune
ms.subservice: apps
ms.localizationpriority: high
ms.technology: ''
ms.assetid: ''
ms.reviewer: ''
ms.suite: ems
search.appverid: MET150
ms.custom: intune-azure
ms.collection: M365-identity-device-management
ms.openlocfilehash: 36b85fa6713af5679e59382efaeb354bb4949705
ms.sourcegitcommit: 302556d3b03f1a4eb9a5a9ce6138b8119d901575
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/27/2020
ms.locfileid: "83990585"
---
# <a name="use-shell-scripts-on-macos-devices-in-intune"></a>Использование скриптов оболочки на устройствах macOS в Intune

Используйте скрипты оболочки, чтобы получить больше возможностей управления устройствами в Intune, чем предоставляет операционная система macOS. 

## <a name="prerequisites"></a>Предварительные условия
При создании скриптов оболочки и назначении их для устройств macOS убедитесь, что выполнены следующие необходимые условия. 
 - Устройства работают под управлением macOS 10.12 или более поздней версии.
 - Устройства управляются Intune. 
 - Скрипты оболочки начинаются с `#!` и должны находиться в допустимом расположении, например `#!/bin/sh` или `#!/usr/bin/env zsh`.
 - Установлены интерпретаторы командной строки для соответствующих оболочек.

## <a name="important-considerations-before-using-shell-scripts"></a>Важные моменты, которые следует учитывать перед использованием скриптов оболочки
 - Для скриптов оболочки требуется установить агент управления Microsoft Intune на устройстве macOS. Дополнительные сведения см. в разделе [Агент управления Microsoft Intune для macOS](macos-shell-scripts.md#microsoft-intune-management-agent-for-macos).
 - Скрипты оболочки выполняются на устройствах параллельно как отдельные процессы.
 - Скрипты оболочки, которые выполняются от имени вошедшего в систему пользователя, будут запускаться для всех учетных записей пользователей, выполнивших вход на устройство во время выполнения.
 - Конечный пользователь должен войти на устройство для выполнения скриптов от имени вошедшего пользователя.
 - Права привилегированного пользователя необходимы в тех случаях, когда скрипт требует внесения изменений, на которые нет разрешений у обычной учетной записи пользователя.
 - В некоторых условиях скрипты оболочки будут пытаться выполняться чаще, чем выбранная периодичность, например если диск заполнен, место хранения изменено, локальный кэш удален или устройство Mac перезапускается.
 
## <a name="create-and-assign-a-shell-script-policy"></a>Создание и назначение политики скрипта оболочки
1. Войдите в [Центр администрирования Microsoft Endpoint Manager](https://go.microsoft.com/fwlink/?linkid=2109431).
2. Выберите **Устройства** > **macOS** > **Скрипты** > **Добавить**.
3. В разделе **Основные** укажите следующие свойства и нажмите **Далее**.
   - **Имя** — Введите имя скрипта оболочки.
   - **Описание**. Введите описание скрипта оболочки. Этот параметр является необязательным, но мы рекомендуем его использовать.
4. В разделе **Параметры скрипта** укажите следующие свойства и нажмите **Далее**.
   - **Отправить сценарий**. Укажите расположение скрипта оболочки. Размер файла скрипта не должен превышать 200 КБ.
   - **Запуск скрипта от имени вошедшего пользователя**. Выберите **Да**, чтобы запускать скрипт с помощью учетных данных пользователя на устройстве. Выберите **Нет** (по умолчанию) для запуска скрипта от имени привилегированного пользователя. 
   - **Скрывать уведомления скрипта на устройствах**. По умолчанию уведомления отображаются для каждого выполняемого скрипта. На устройствах macOS пользователи будут видеть уведомление от Intune *IT is configuring your computer* (Специалисты из ИТ-отдела настраивают ваш компьютер)
   - **Частота выполнения сценария**. Выберите частоту выполнения скрипта. Чтобы выполнить скрипт один раз, выберите **Не настроено** (по умолчанию).
   - **Максимальное число повторных попыток при сбое сценария**. Выберите, сколько раз должен выполняться скрипт, если он возвращает ненулевой код завершения (ноль свидетельствует об успешном выполнении). Чтобы не выполнять скрипт повторно в случае сбоя, выберите **Не настроено** (по умолчанию).
5. В разделе **Теги области** дополнительно добавьте теги области для скрипта и нажмите **Далее**. Используя теги области в Intune, вы можете определить, кто может просматривать скрипты. Полные сведения о тегах области см. в статье [Use role-based access control (RBAC) and scope tags for distributed IT](../fundamentals/scope-tags.md) (Использование управления доступом на основе ролей (RBAC) и тегов области для распределенной ИТ-разработки).
6. Выберите пункты **Назначения** > **Выберите группы для включения**. Отобразится существующий список групп Azure AD. Выберите одну группу пользователей или устройств или несколько, которые должны получить скрипт. Щелкните **Выбрать**. Выбранные группы отображаются в списке и получат вашу политику скрипта.
   > [!NOTE]
   > - Скрипты оболочки, назначенные группам пользователей, применяются ко всем пользователям, входящим в систему на компьютере Mac.  
   > - При обновлении назначений для скриптов оболочки также обновляются назначения для [агента Microsoft Intune MDM для macOS](macos-shell-scripts.md#microsoft-intune-management-agent-for-macos).

7. В окне **Проверка и добавление** отображается сводка по настроенным параметрам. Выберите **Добавить**, чтобы сохранить сценарий. При нажатии кнопки **Добавить** политика скрипта развертывается в выбранных группах.

Созданный вами скрипт отображается в списке скриптов. 

## <a name="monitor-a-shell-script-policy"></a>Мониторинг политики скрипта оболочки
Вы можете отслеживать состояние выполнения всех назначенных скриптов для пользователей и устройств в одном из следующих отчетов:
- **Скрипты** > **выберите скрипт для отслеживания** > **Состояние устройства**
- **Скрипты** > **выберите скрипт для отслеживания** > **Состояние пользователя**

>[!IMPORTANT]
> Независимо от выбранной **частоты скрипта** состояние выполнения скрипта выводится только при первом запуске. Состояние выполнения скрипта не обновляется при последующих запусках. Однако обновленные скрипты считаются новыми, и их состояние выполнения указывается.

После выполнения скрипт возвращает одно из следующих состояний:
- Состояние выполнения скрипта **Сбой** указывает, что скрипт вернул ненулевой код выхода или имеет неправильный формат. 
- Состояние выполнения скрипта **Успешно** указывает, что скрипт вернул ноль в качестве кода выхода. 

## <a name="troubleshoot-macos-shell-script-policies-using-log-collection"></a>Устранение неполадок с политиками скриптов оболочки macOS с помощью сбора журналов

Вы можете собирать журналы устройств для помощи в устранении неполадок, связанных со скриптами, на устройствах macOS. 

### <a name="requirements-for-log-collection"></a>Требования для сбора журналов
Для сбора журналов на устройстве macOS должны быть выполнены перечисленные ниже условия.
- Необходимо указать полный абсолютный путь к файлу журнала.
- Пути к файлам должны разделяться только точкой с запятой (;).
- Максимальный размер коллекции журналов — 60 МБ (в сжатом виде) или 25 файлов в зависимости от того, какое ограничение будет превышено раньше.
- При сборе журналов допускаются следующие расширения имен файлов: *.log, .zip, .gz, .tar, .txt, .xml, .crash, .rtf*

#### <a name="collect-device-logs"></a>Сбор журналов устройств
1. Войдите в [Центр администрирования Microsoft Endpoint Manager](https://go.microsoft.com/fwlink/?linkid=2109431).
2. В отчете **Состояние устройства** или **Состояние пользователя** выберите устройство.
3. Выберите **Собрать журналы**, укажите пути к папкам с файлами журналов через точку с запятой (;) без пробелов или символов новой строки между путями.<br>Например, несколько путей можно записывать так: `/Path/to/logfile1.zip;/Path/to/logfile2.log`. 

   >[!IMPORTANT]
   > Если несколько путей к файлам журналов будут разделены запятыми, точками, символами новой строки или кавычками с пробелами или без, при сборе журналов произойдет ошибка. Пробелы также нельзя использовать в качестве разделителей между путями.

4. Нажмите кнопку **OK**. Журналы будут собраны при следующей синхронизации агента управления Intune на устройстве с Intune. Синхронизация обычно выполняется каждые 8 часов.

   >[!NOTE]
   > 
   > - Собранные журналы шифруются на устройстве, передаются в хранилище Microsoft Azure и хранятся в нем 30 дней. Хранящиеся журналы расшифровываются по запросу и скачиваются с помощью центра администрирования Microsoft Endpoint Manager.
   > - Помимо журналов, указанных администратором, также собираются журналы агента управления Intune из следующих папок: `/Library/Logs/Microsoft/Intune` и `~/Library/Logs/Microsoft/Intune`. Имена файлов журналов агента — `IntuneMDMDaemon date--time.log` и `IntuneMDMAgent date--time.log`. 
   > - Если какой-либо файл, указанный администратором, отсутствует или имеет неверное расширение имени, его имя будет указано в списке `LogCollectionInfo.txt`.     

### <a name="log-collection-errors"></a>Ошибки при сборе журналов
Сбор журналов может завершиться неудачно по одной из причин, приведенных в таблице ниже. Чтобы устранить эти ошибки, выполните инструкции по исправлению.

| Код ошибки (шестнадцатеричный) | Код ошибки (десятичный) | Сообщение об ошибке | Действия по устранению проблемы |
|------------------|------------------|---------------|-------------------|
| 0X87D300D1 | 2016214834 | Размер файла журнала не может превышать 60 МБ. | Убедитесь в том, что размер сжатых журналов меньше 60 МБ. |
| 0X87D300D1 | 2016214831 | Указанный путь к файлу журнала должен существовать. Системная папка пользователя не может использоваться для файлов журналов. | Убедитесь в правильности и доступности пути. |
| 0X87D300D2 | 2016214830 | Не удалось отправить файл коллекции журналов из-за истечения срока действия URL-адреса отправки. | Попробуйте выполнить действие **Собрать журналы** еще раз. |
| 0X87D300D3, 0X87D300D5, 0X87D300D7 | 2016214829, 2016214827, 2016214825 | Не удалось отправить файл коллекции журналов из-за сбоя шифрования. Попробуйте отправить журнал еще раз. | Попробуйте выполнить действие **Собрать журналы** еще раз. |
| | 2016214828 | Число файлов журналов превысило допустимый предел в 25 файлов. | За один раз можно собрать до 25 файлов журналов. |
| 0X87D300D6 | 2016214826 | Не удалось отправить файл коллекции журналов из-за ошибки ZIP-архива. Попробуйте отправить журнал еще раз. | Попробуйте выполнить действие **Собрать журналы** еще раз. |
| | 2016214740 | Не удалось зашифровать журналы, так как сжатые журналы не найдены. | Попробуйте выполнить действие **Собрать журналы** еще раз. |
| | 2016214739 | Журналы были собраны, но их не удалось сохранить. | Попробуйте выполнить действие **Собрать журналы** еще раз. |

## <a name="frequently-asked-questions"></a>Часто задаваемые вопросы
### <a name="why-are-assigned-shell-scripts-not-running-on-the-device"></a>Почему назначенные скрипты оболочки не выполняются на устройстве?
Существует несколько возможных причин:
* Для получения новых или обновленных скриптов агенту может потребоваться синхронизация. Синхронизация выполняется каждые 8 часов и отличается от синхронизации MDM. Убедитесь, что устройство активно и подключено к сети для успешной синхронизации агента, и дождитесь синхронизации агента. Можно также требовать, чтобы пользователь открыл Корпоративный портал на компьютере Mac, выбрал устройство и нажал **Проверить параметры**.
* Возможно, агент не установлен. Убедитесь, что агент установлен в `/Library/Intune/Microsoft Intune Agent.app` на устройстве macOS.
* Возможно, агент находится в неработоспособном состоянии. Агент попытается выполнить восстановление в течение 24 часов, удалится и переустановится, если скрипты оболочки все еще назначены.

### <a name="how-frequently-is-script-run-status-reported"></a>Как часто выводится состояние выполнения скрипта?
Состояние выполнения скрипта выводится на консоли администрирования Microsoft Endpoint Manager сразу после завершения выполнения скрипта. Если запланировано периодическое выполнение скрипта с заданной частотой, сведения о состоянии сообщаются только при первом запуске.

### <a name="when-are-shell-scripts-run-again"></a>Когда скрипты оболочки запускаются повторно?
Скрипт запускается снова только в том случае, если настроен параметр **Максимальное число повторных попыток при сбое скрипта**, и при запуске скрипта происходит сбой. Если **Максимальное число повторных попыток при сбое скрипта** не настроено и при выполнении скрипта происходит сбой, он не будет запущен повторно, а состояние выполнения будет указано как **Сбой**. 

### <a name="what-intune-role-permissions-are-required-for-shell-scripts"></a>Какие разрешения роли Intune требуются для скриптов оболочки?
Назначенная роль Intune требует разрешения **конфигураций устройств** для удаления, назначения, создания, обновления или чтения скриптов оболочки.

## <a name="microsoft-intune-management-agent-for-macos"></a>Агент управления Microsoft Intune для macOS
 ### <a name="why-is-the-agent-required"></a>Зачем нужен агент?
Агент управления Microsoft Intune необходимо установить на управляемых устройствах macOS, чтобы обеспечить расширенные возможности управления устройствами, которые не поддерживаются в собственной операционной системе macOS.
 
 ### <a name="how-is-the-agent-installed"></a>Как устанавливается агент?
 Агент устанавливается автоматически на устройства macOS, управляемые Intune, которым в Центре администрирования Microsoft Endpoint Manager назначен по крайней мере один скрипт оболочки. Агент устанавливается в `/Library/Intune/Microsoft Intune Agent.app`, когда это применимо, и не отображается в разделе **Finder** > **Приложения** на устройствах macOS. Агент отображается как `IntuneMdmAgent` в **мониторе активности** при запуске на устройствах macOS.

### <a name="what-does-the-agent-do"></a>Что делает агент?
 - Агент автоматически проходит проверку подлинности в службах Intune перед синхронизацией, чтобы получить назначенные скрипты оболочки для устройства macOS.
 - Агент получает назначенные скрипты оболочки и запускает их на основе настроенного расписания, повторных попыток, параметров уведомлений и других параметров, заданных администратором.
 - Агент проверяет наличие новых или обновленных скриптов с помощью служб Intune, обычно каждые 8 часов. Этот процесс синхронизации не зависит от синхронизации MDM. 
 
 ### <a name="how-can-i-manually-initiate-an-agent-check-in-from-a-mac"></a>Как вручную запустить синхронизацию агента на компьютере Mac?
На управляемом компьютере Mac с установленным агентом откройте **Корпоративный портал**, выберите локальное устройство и нажмите **Проверить параметры**. Будет запущена синхронизация MDM, а также синхронизация агента.

Можно также открыть **терминал** и выполнить команду `sudo killall IntuneMdmAgent`, чтобы завершить процесс `IntuneMdmAgent`. Процесс `IntuneMdmAgent` будет сразу перезапущен и начнется синхронизация с Intune.

> [!NOTE]
> Действие **Синхронизация** для устройств в консоли администрирования Microsoft Endpoint Manager инициируют синхронизацию MDM без принудительной синхронизации агента.

 ### <a name="when-is-the-agent-removed"></a>Когда агент удаляется?
 Существует несколько условий, которые могут привести к удалению агента с устройства, например:
 - Скрипты оболочки больше не назначены устройству. 
 - Устройство macOS больше не управляется.
 - Агент находится в неисправимом состоянии более 24 часов (время ожидания устройства).

 ### <a name="why-are-scripts-running-even-though-the-mac-is-no-longer-managed"></a>Почему скрипты продолжают выполняться, даже если Mac больше не управляется?
 Когда Mac с назначенными скриптами перестает быть управляемым, не происходит немедленное удаление агента. Агент обнаруживает, что Mac не управляется, при следующей синхронизации агента (обычно каждые 8 часов) и отменяет запланированные запуски скрипта. Таким образом, все локально хранимые скрипты, для которых запланировано более частое выполнение, будут выполняться до следующей запланированной синхронизации агента. Если не удается выполнить синхронизацию агента, то повторные попытки синхронизации предпринимаются до 24 часов (время нахождения устройства в активном состоянии), а затем агент удаляет себя с компьютера Mac.
 
 ### <a name="how-to-turn-off-usage-data-sent-to-microsoft-for-shell-scripts"></a>Как отключить данные об использовании, отправляемые в корпорацию Майкрософт о скриптах оболочки?
 Чтобы отключить данные об использовании, отправляемые в корпорацию Майкрософт из агента управления Intune, откройте Корпоративный портал и выберите **Меню** > **Параметры** > *и снимите флажок "Разрешить Майкрософт получать данные об использовании"* . Таким образом вы отключите отправку данных об использовании как для агента, так и для Корпоративного портала.

## <a name="known-issues"></a>Известные проблемы
- **Нет состояния выполнения скрипта**. В редких случаях, когда скрипт получен устройством, но устройство выходит из сети до получения сообщения о состоянии выполнения, устройство не будет сообщать о состоянии выполнения скрипта в консоли администрирования.

## <a name="next-steps"></a>Дальнейшие шаги

- [Создание политики соответствия требованиям в Microsoft Intune](..\protect\create-compliance-policy.md)
